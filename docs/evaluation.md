# 기장 시스템 현실 평가서

## 실제 기장 프로세스 시나리오

### 시나리오: "월초에 세무사가 하는 일"

```
1. 거래처 A사의 기장 데이터를 받는다:
   - 국민은행 통장 거래내역 (엑셀) → 날짜=2026.01.05, 열=거래일|적요|입금|출금|잔액
   - 신한카드 사용내역 (엑셀)    → 날짜=2026/1/5,  열=이용일|이용내역|이용금액|승인번호
   - 카카오뱅크 내역 (CSV)       → 날짜=20260105,   열=date|description|credit|debit|balance
   - 수기 현금영수증 (PDF/이미지)

2. 전처리 (이 단계가 핵심):
   a. 은행별 포맷 통일 → "표준 장부 포맷" (날짜|적요|입금|출금|잔액|계정과목)
   b. 카드사 포맷 통일 → 카드 사용내역도 같은 표준 포맷으로
   c. 날짜 정규화      → 모든 날짜를 YYYY-MM-DD로
   d. 금액 정규화      → 쉼표, 원, 천원 단위 등 통일
   e. 시간순 정렬      → 전체 데이터를 날짜 기준으로 정렬
   f. 중복 탐지        → 같은 거래가 은행/카드에 동시 출현할 때 매칭
   g. 계정과목 자동분류 → 적요 기반 (BUT 정확도가 생명)
   h. 잔액 검증        → 정렬 후 잔액이 맞는지 cross-check

3. 분류 확인 & 보정:
   - 자동분류 결과를 세무사가 검토
   - 틀린 것 수정 → 학습 데이터로 축적

4. 산출물 생성:
   - 일/월계표, 계정별 원장, 부가세 신고 자료, 세무조정 데이터
```

---

## 현재 시스템 기능별 평가

### 1. 파일 업로드 & 데이터 추출 (process_excel)

**현재 구현:**
```python
# tasks.py - process_excel() 전문
wb = openpyxl.load_workbook(document.file.path)
sheet = wb.active
data = []
for row in sheet.iter_rows(values_only=True):
    data.append(list(row))
headers = data[0]
rows = data[1:]
```

**문제점:**
- 1행이 무조건 헤더라고 가정 → 은행 통장 엑셀은 1~3행이 제목/기관명/기간인 경우가 대부분
- header_detector가 있지만 **업로드 시 사용 안 함** (병합에서만 사용)
- 날짜가 문자열 그대로 저장 → datetime 객체도, 엑셀 시리얼넘버도 변환 없이 raw 저장
- 숫자에 쉼표("1,000,000")가 그대로 저장 → 이후 분석에서 매번 파싱 반복
- **active 시트만 읽음** → 다중 시트 엑셀 무시

**심각도: 🔴 치명적** - 은행 실제 엑셀을 올리면 높은 확률로 헤더 인식 실패

---

### 2. 병합 (merge_service.py)

**현재 구현:**
```
파일A 전체 → 파일B 전체 → ... 순서대로 이어붙이기 (concat)
```

**검증 - 실제 병합 결과:**
```
FlutterExcel_1.xlsx → 4행 (시간: 문자열 "2025-08-01 18:08")
FlutterExcel.xlsx   → 4행 (시간: datetime 2025-08-02T18:08:00)
                      ↓
병합 결과: 파일1-행1, 파일1-행2, ..., 파일2-행1, 파일2-행2, ...
```

**문제점:**
- ❌ **정렬 없음**: 시간순 정렬이 안 됨 (유저가 직접 확인한 문제)
- ❌ **날짜 정규화 미적용**: date_columns=[] 이기 때문. 자동감지해서 적용해야 하는데 안 함
- ❌ **같은 파일 중복 감지 없음**: 같은 파일 2번 올리면 그냥 2배로 됨
- ❌ **날짜 포맷 불일치**: 같은 열인데 파일마다 "2025-08-01 18:08" vs "2025-08-02T18:08:00"
- ❌ **데이터 타입 불일치**: 한 파일은 문자열, 다른 파일은 datetime → 섞여서 출력
- △ 열 매핑은 있지만, 기본 date_columns 자동 감지가 없어서 사용자가 수동 설정 필요

**심각도: 🔴 치명적** - "날짜 정규화가 핵심"이라고 했는데 실제로 작동 안 함

---

### 3. 분석 기능 (vat_report, monthly_report 등)

**유저 지적 그대로:**
> "이건 단순 분석 - 이미 어느 정도 추출된 파일이면, 엑셀에서도 충분히 가능한 기능들이야."

**검증:**
- `vat_report`: 모든 금액을 **무조건 부가세 포함가로 가정** (÷11). 면세 사업자, 영세율, 간이과세 구분 없음.
  실제 부가세 신고는 세금계산서/신용카드/현금영수증 별로 구분 필요.
- `monthly_report`: 월별 SUM - 엑셀 피벗 테이블 10초 작업
- `classify_transaction`: 키워드 매칭 19개 카테고리 - "급여"라는 단어 포함 → 급여. 동명이인 거래처면?
- `extract_vendors`: 적요에서 접두어 제거하면 거래처명이라는 가정 - 실제 은행 적요는 훨씬 복잡

**심각도: 🟡 보통** - 있으면 편하지만, 엑셀 대비 차별 가치 낮음

---

### 4. 거래 분류 수정

**현재 구현:**
```python
# classify API: metadata.user_classifications에 {row_index: category} 저장
# 문제: 학습 안 함. 저장만 하고, 다음 파일에 반영 안 됨.
```

**문제점:**
- 사용자 수정 사항이 다른 문서에 전파되지 않음
- "A거래처 → 매출" 이라고 수정해도, 새 파일 올리면 또 "미분류"
- 거래처↔계정과목 매핑 테이블이 없음

**심각도: 🟡 보통**

---

## 핵심 문제 요약

### 프리프로세싱이 사실상 없다

```
현재 플로우:
  엑셀 업로드 → openpyxl.load → 첫 행을 헤더로 → raw 저장 → (끝)
  
필요한 플로우:
  엑셀 업로드
    → 은행/카드사 포맷 자동 감지 (header_detector 활용)
    → 실제 헤더 행 찾기
    → 표준 포맷 매핑 (열 이름 통일)
    → 날짜 정규화 (모든 날짜 → YYYY-MM-DD)
    → 금액 정규화 (쉼표 제거, 숫자 변환)
    → 시간순 정렬
    → 잔액 검증
    → 계정과목 자동분류
    → 정규화된 데이터 저장
```

`normalizers.py`, `header_detector.py`, `column_mapper.py`라는 **좋은 유틸리티가 이미 있는데**,
`process_excel()`에서 **하나도 사용하지 않고** 있다.

### 병합에서도 프리프로세싱이 반쪽

- `date_columns=[]`이 기본값이라 날짜 정규화가 자동 적용 안 됨
- 타입 분석(`_analyze_column_types`)으로 어떤 열이 날짜인지 **이미 알고 있는데** 자동 적용 안 함
- 정렬 기능 자체가 없음

---

## 개선이 필요한 것 (우선순위)

### P0: process_excel 전면 개편 (프리프로세싱)
1. header_detector로 실제 헤더 행 찾기
2. column_mapper로 표준 열 이름 매핑
3. DateNormalizer로 날짜 통일
4. NumberNormalizer로 금액 통일  
5. 날짜 기준 정렬
6. classify_transaction으로 계정과목 자동분류
7. 정규화된 structured_data에 저장

### P0: 병합 시 자동 날짜감지 + 정렬
1. 분석 단계에서 감지된 date 타입 열을 자동으로 date_columns에 추가
2. 병합 후 날짜 열 기준 정렬
3. 중복 행 탐지 (같은 날짜+금액+적요 = 의심 중복)

### P1: 분류 학습
1. 거래처↔계정과목 매핑 테이블 생성
2. 사용자 수정 시 매핑 테이블 갱신
3. 새 파일 업로드 시 매핑 테이블 우선 적용

### P2: 분석 차별화
1. 부가세: 세금계산서/신용카드/현금영수증 구분
2. 잔액 검증 (계산 잔액 vs 실제 잔액 불일치 탐지)
3. 이상 거래 탐지 (평소 대비 큰 금액, 주말 거래 등)
