{% extends "base.html" %}
{% block title %}ê±°ë˜ì²˜ ê´€ë¦¬ - ê¸°ì¥{% endblock %}
{% block nav_vendors %}active{% endblock %}
{% block page_title %}ê±°ë˜ì²˜ ê´€ë¦¬{% endblock %}

{% block top_actions %}
<button class="btn btn-primary" onclick="showAddVendor()">+ ê±°ë˜ì²˜ ì¶”ê°€</button>
{% endblock %}

{% block extra_head %}
<style>
.vendor-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.vs-card { background: #fff; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
.vs-card .vs-label { font-size: .8rem; color: var(--c-gray-500); margin-bottom: .25rem; }
.vs-card .vs-value { font-size: 1.5rem; font-weight: 700; }

.vendor-toolbar { display: flex; gap: .75rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
.vendor-toolbar input, .vendor-toolbar select { height: 36px; padding: 0 .75rem; border: 1px solid var(--c-gray-200); border-radius: 8px; font-size: .85rem; }
.vendor-toolbar .search { flex: 1; min-width: 200px; }

.vendor-table { width: 100%; border-collapse: collapse; font-size: .85rem; }
.vendor-table th { background: #f8fafc; padding: .6rem .5rem; text-align: left; border-bottom: 2px solid var(--c-gray-200); cursor: pointer; }
.vendor-table th:hover { background: #e2e8f0; }
.vendor-table td { padding: .5rem; border-bottom: 1px solid var(--c-gray-100); }
.vendor-table tr:hover { background: #f1f5f9; }
.vendor-table td.num { text-align: right; font-variant-numeric: tabular-nums; }

.type-badge { font-size: .75rem; padding: .15rem .5rem; border-radius: 4px; }
.type-customer { background: #dcfce7; color: #166534; }
.type-supplier { background: #fee2e2; color: #991b1b; }
.type-both { background: #e0e7ff; color: #3730a3; }

.vendor-actions { display: flex; gap: .25rem; }
.vendor-actions button { padding: .2rem .5rem; font-size: .75rem; border: 1px solid var(--c-gray-200); border-radius: 4px; background: #fff; cursor: pointer; }
.vendor-actions button:hover { background: #f1f5f9; }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; margin-bottom: .75rem; }
.form-group { margin-bottom: .5rem; }
.form-group label { display: block; font-size: .8rem; font-weight: 500; margin-bottom: .25rem; }
.form-group input, .form-group select, .form-group textarea {
  width: 100%; height: 36px; padding: 0 .75rem; border: 1px solid var(--c-gray-200);
  border-radius: 8px; font-size: .85rem; box-sizing: border-box;
}
.form-group textarea { height: 60px; padding: .5rem .75rem; resize: vertical; }

@media (max-width: 768px) {
  .vendor-stats { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
}
</style>
{% endblock %}

{% block content %}
<!-- í†µê³„ ì¹´ë“œ -->
<div class="vendor-stats" id="vendor-stats">
  <div class="vs-card">
    <div class="vs-label">ì „ì²´ ê±°ë˜ì²˜</div>
    <div class="vs-value" id="vs-total">-</div>
  </div>
  <div class="vs-card">
    <div class="vs-label">ë§¤ì¶œì²˜ (ê³ ê°)</div>
    <div class="vs-value" id="vs-customers" style="color:#10b981;">-</div>
  </div>
  <div class="vs-card">
    <div class="vs-label">ë§¤ì…ì²˜ (ê±°ë˜ì²˜)</div>
    <div class="vs-value" id="vs-suppliers" style="color:#ef4444;">-</div>
  </div>
</div>

<!-- íˆ´ë°” -->
<div class="section" style="background:#fff;border-radius:12px;padding:1.25rem;box-shadow:0 1px 4px rgba(0,0,0,.06);">
  <div class="vendor-toolbar">
    <input type="text" class="search" id="vendor-search" placeholder="ğŸ” ê±°ë˜ì²˜ëª…, ì‚¬ì—…ìë²ˆí˜¸ ê²€ìƒ‰...">
    <select id="vendor-type-filter">
      <option value="">ì „ì²´ ìœ í˜•</option>
      <option value="customer">ë§¤ì¶œì²˜</option>
      <option value="supplier">ë§¤ì…ì²˜</option>
      <option value="both">ê²¸ìš©</option>
    </select>
  </div>
  
  <div style="overflow-x:auto;">
    <table class="vendor-table" id="vendor-table">
      <thead>
        <tr>
          <th>ê±°ë˜ì²˜ëª…</th>
          <th>ìœ í˜•</th>
          <th>ê³„ì •ê³¼ëª©</th>
          <th>ì‚¬ì—…ìë²ˆí˜¸</th>
          <th style="text-align:right">ì…ê¸ˆì•¡</th>
          <th style="text-align:right">ì¶œê¸ˆì•¡</th>
          <th style="text-align:right">ê±°ë˜ê±´ìˆ˜</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="vendor-tbody">
        <tr><td colspan="8" class="empty-state">ë¡œë”© ì¤‘...</td></tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function money(v) {
  if (v == null || isNaN(v) || v === 0) return '-';
  return Math.round(v).toLocaleString() + 'ì›';
}

function typeBadge(t) {
  const map = {
    customer: ['ë§¤ì¶œì²˜', 'type-customer'],
    supplier: ['ë§¤ì…ì²˜', 'type-supplier'],
    both: ['ê²¸ìš©', 'type-both'],
  };
  const [label, cls] = map[t] || [t, ''];
  return `<span class="type-badge ${cls}">${label}</span>`;
}

async function loadVendors() {
  try {
    const search = document.getElementById('vendor-search').value;
    const typeFilter = document.getElementById('vendor-type-filter').value;
    
    let url = '/api/documents/vendors/?ordering=-transaction_count';
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (typeFilter) url += `&vendor_type=${typeFilter}`;
    
    const [vendors, summary] = await Promise.all([
      API.get(url),
      API.get('/api/documents/vendors/summary/'),
    ]);
    
    // í†µê³„
    document.getElementById('vs-total').textContent = summary.total_vendors;
    document.getElementById('vs-customers').textContent = summary.customers.count;
    document.getElementById('vs-suppliers').textContent = summary.suppliers.count;
    
    // í…Œì´ë¸”
    const results = vendors.results || vendors;
    const tbody = document.getElementById('vendor-tbody');
    
    if ((!Array.isArray(results) && !results.length) || (Array.isArray(results) && results.length === 0)) {
      tbody.innerHTML = '<tr><td colspan="8" class="empty-state">ë“±ë¡ëœ ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤. ê±°ë˜ë‚´ì—­ì—ì„œ ìë™ ì¶”ì¶œí•˜ê±°ë‚˜ ì§ì ‘ ì¶”ê°€í•´ë³´ì„¸ìš”.</td></tr>';
      return;
    }
    
    const list = Array.isArray(results) ? results : [results];
    tbody.innerHTML = list.map(v => `
      <tr>
        <td><strong>${escapeHtml(v.name)}</strong></td>
        <td>${typeBadge(v.vendor_type)}</td>
        <td>${v.category ? `<span class="cat-badge" style="font-size:.75rem;padding:.1rem .4rem;border-radius:4px;background:#e0e7ff;color:#3730a3;">${escapeHtml(v.category)}</span>` : '-'}</td>
        <td>${v.business_number || '-'}</td>
        <td class="num" style="color:#10b981;">${money(v.total_income)}</td>
        <td class="num" style="color:#ef4444;">${money(v.total_expense)}</td>
        <td class="num">${v.transaction_count}ê±´</td>
        <td class="vendor-actions">
          <button onclick="editVendor(${v.id})">âœï¸</button>
          <button onclick="deleteVendor(${v.id}, '${escapeHtml(v.name)}')">ğŸ—‘</button>
        </td>
      </tr>
    `).join('');
    
  } catch(err) {
    console.error('Vendor load error:', err);
    showToast('ê±°ë˜ì²˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + (err.message || ''), 'error');
  }
}

function showAddVendor() {
  showModal('ê±°ë˜ì²˜ ì¶”ê°€', `
    <div class="form-row">
      <div class="form-group">
        <label>ê±°ë˜ì²˜ëª… *</label>
        <input type="text" id="v-name" required>
      </div>
      <div class="form-group">
        <label>ìœ í˜•</label>
        <select id="v-type">
          <option value="supplier">ë§¤ì…ì²˜ (ê±°ë˜ì²˜)</option>
          <option value="customer">ë§¤ì¶œì²˜ (ê³ ê°)</option>
          <option value="both">ê²¸ìš©</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>ì‚¬ì—…ìë²ˆí˜¸</label>
        <input type="text" id="v-biznum" placeholder="000-00-00000">
      </div>
      <div class="form-group">
        <label>ê³„ì •ê³¼ëª©</label>
        <input type="text" id="v-category" placeholder="ì˜ˆ: ì™¸ì£¼ë¹„, ì†Œëª¨í’ˆë¹„">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>ë‹´ë‹¹ìëª…</label>
        <input type="text" id="v-contact">
      </div>
      <div class="form-group">
        <label>ì „í™”ë²ˆí˜¸</label>
        <input type="text" id="v-phone">
      </div>
    </div>
    <div class="form-group">
      <label>ì´ë©”ì¼</label>
      <input type="email" id="v-email">
    </div>
    <div class="form-group">
      <label>ë©”ëª¨</label>
      <textarea id="v-memo"></textarea>
    </div>
  `, `<button class="btn btn-primary" onclick="saveVendor()">ì €ì¥</button>
     <button class="btn btn-ghost" onclick="closeModal()">ì·¨ì†Œ</button>`);
}

async function saveVendor(vendorId) {
  const data = {
    name: document.getElementById('v-name').value,
    vendor_type: document.getElementById('v-type').value,
    business_number: document.getElementById('v-biznum').value,
    category: document.getElementById('v-category').value,
    contact_name: document.getElementById('v-contact').value,
    phone: document.getElementById('v-phone').value,
    email: document.getElementById('v-email').value,
    memo: document.getElementById('v-memo').value,
  };
  
  if (!data.name) {
    showToast('ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    return;
  }
  
  try {
    if (vendorId) {
      await API.put(`/api/documents/vendors/${vendorId}/`, data);
      showToast('ê±°ë˜ì²˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      await API.post('/api/documents/vendors/', data);
      showToast('ê±°ë˜ì²˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    closeModal();
    loadVendors();
  } catch(err) {
    showToast(err.message || 'ì €ì¥ ì‹¤íŒ¨', 'error');
  }
}

async function editVendor(id) {
  try {
    const v = await API.get(`/api/documents/vendors/${id}/`);
    showModal('ê±°ë˜ì²˜ ìˆ˜ì •', `
      <div class="form-row">
        <div class="form-group">
          <label>ê±°ë˜ì²˜ëª… *</label>
          <input type="text" id="v-name" value="${escapeHtml(v.name || '')}">
        </div>
        <div class="form-group">
          <label>ìœ í˜•</label>
          <select id="v-type">
            <option value="supplier" ${v.vendor_type==='supplier'?'selected':''}>ë§¤ì…ì²˜</option>
            <option value="customer" ${v.vendor_type==='customer'?'selected':''}>ë§¤ì¶œì²˜</option>
            <option value="both" ${v.vendor_type==='both'?'selected':''}>ê²¸ìš©</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ì‚¬ì—…ìë²ˆí˜¸</label>
          <input type="text" id="v-biznum" value="${escapeHtml(v.business_number || '')}">
        </div>
        <div class="form-group">
          <label>ê³„ì •ê³¼ëª©</label>
          <input type="text" id="v-category" value="${escapeHtml(v.category || '')}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ë‹´ë‹¹ìëª…</label>
          <input type="text" id="v-contact" value="${escapeHtml(v.contact_name || '')}">
        </div>
        <div class="form-group">
          <label>ì „í™”ë²ˆí˜¸</label>
          <input type="text" id="v-phone" value="${escapeHtml(v.phone || '')}">
        </div>
      </div>
      <div class="form-group">
        <label>ì´ë©”ì¼</label>
        <input type="email" id="v-email" value="${escapeHtml(v.email || '')}">
      </div>
      <div class="form-group">
        <label>ë©”ëª¨</label>
        <textarea id="v-memo">${escapeHtml(v.memo || '')}</textarea>
      </div>
    `, `<button class="btn btn-primary" onclick="saveVendor(${id})">ìˆ˜ì •</button>
       <button class="btn btn-ghost" onclick="closeModal()">ì·¨ì†Œ</button>`);
  } catch(err) {
    showToast('ê±°ë˜ì²˜ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨', 'error');
  }
}

async function deleteVendor(id, name) {
  if (!confirm(`"${name}" ê±°ë˜ì²˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  try {
    await API.delete(`/api/documents/vendors/${id}/`);
    showToast('ê±°ë˜ì²˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    loadVendors();
  } catch(err) {
    showToast(err.message || 'ì‚­ì œ ì‹¤íŒ¨', 'error');
  }
}

// ê²€ìƒ‰
let searchTimer;
document.getElementById('vendor-search').addEventListener('input', () => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(loadVendors, 400);
});
document.getElementById('vendor-type-filter').addEventListener('change', loadVendors);

document.addEventListener('DOMContentLoaded', loadVendors);
</script>
{% endblock %}
