{% extends "base.html" %}
{% block title %}íŒŒì¼ ë³‘í•© - DocMerge{% endblock %}
{% block nav_merge %}active{% endblock %}
{% block page_title %}íŒŒì¼ ë³‘í•©{% endblock %}

{% block top_actions %}
<button class="btn btn-primary" id="btn-new-project">+ ìƒˆ í”„ë¡œì íŠ¸</button>
{% endblock %}

{% block content %}
<!-- í”„ë¡œì íŠ¸ ëª©ë¡ -->
<div id="project-list-section">
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>í”„ë¡œì íŠ¸ëª…</th>
          <th>ìƒíƒœ</th>
          <th>íŒŒì¼ ìˆ˜</th>
          <th>ìƒì„±ì¼</th>
          <th>ì‘ì—…</th>
        </tr>
      </thead>
      <tbody id="projects-body">
        <tr><td colspan="5" class="empty-state">ë¡œë”© ì¤‘...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- í”„ë¡œì íŠ¸ ìƒì„¸ (ìˆ¨ê¹€ ê¸°ë³¸) -->
<div id="project-detail-section" style="display:none;">
  <button class="btn btn-ghost mb-2" id="btn-back-list">â† ëª©ë¡ìœ¼ë¡œ</button>
  <div class="card" id="project-info-card">
    <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ========================
// í”„ë¡œì íŠ¸ ëª©ë¡
// ========================
async function loadProjects() {
  try {
    const data = await API.get('/api/documents/merge-projects/');
    const results = data.results || [];
    const tbody = document.getElementById('projects-body');

    if (results.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="empty-state">í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. "ìƒˆ í”„ë¡œì íŠ¸"ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</td></tr>';
    } else {
      tbody.innerHTML = results.map(p => `
        <tr>
          <td><a href="#" class="link" onclick="openProject(${p.id}); return false;"><strong>${escapeHtml(p.name)}</strong></a></td>
          <td>${mergeStatusBadge(p.status)}</td>
          <td>${p.file_count || (p.files || []).length}ê°œ</td>
          <td>${formatDate(p.created_at)}</td>
          <td class="actions">
            <button class="btn btn-xs btn-ghost" onclick="openProject(${p.id})">ìƒì„¸</button>
            <button class="btn btn-xs btn-danger" onclick="deleteProject(${p.id})">ğŸ—‘</button>
          </td>
        </tr>
      `).join('');
    }
  } catch(err) {
    showToast('í”„ë¡œì íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
  }
}

// ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
document.getElementById('btn-new-project').addEventListener('click', () => {
  showModal('ìƒˆ ë³‘í•© í”„ë¡œì íŠ¸', `
    <form id="new-project-form">
      <div class="form-group">
        <label>í”„ë¡œì íŠ¸ëª… <span class="required">*</span></label>
        <input type="text" id="project-name" class="form-input" placeholder="ì˜ˆ: 2026ë…„ 1ì›” ë§¤ì¶œí˜„í™© í†µí•©" required>
      </div>
      <div class="form-group">
        <label>ì„¤ëª…</label>
        <textarea id="project-desc" class="form-textarea" placeholder="í”„ë¡œì íŠ¸ ì„¤ëª… (ì„ íƒ)" rows="2"></textarea>
      </div>
      <button type="submit" class="btn btn-primary btn-full">ìƒì„±</button>
    </form>
  `);

  document.getElementById('new-project-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      const res = await API.post('/api/documents/merge-projects/', {
        name: document.getElementById('project-name').value,
        description: document.getElementById('project-desc').value,
      });
      closeModal();
      showToast('í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
      openProject(res.id);
      loadProjects();
    } catch(err) {
      showToast(err.message || 'ìƒì„± ì‹¤íŒ¨', 'error');
    }
  });
});

async function deleteProject(id) {
  if (!confirm('í”„ë¡œì íŠ¸ì™€ ëª¨ë“  íŒŒì¼ì´ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await API.delete(`/api/documents/merge-projects/${id}/`);
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    loadProjects();
  } catch(err) {
    showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
  }
}

// ========================
// í”„ë¡œì íŠ¸ ìƒì„¸ / ì›Œí¬í”Œë¡œìš°
// ========================
let currentProject = null;

document.getElementById('btn-back-list').addEventListener('click', () => {
  document.getElementById('project-detail-section').style.display = 'none';
  document.getElementById('project-list-section').style.display = 'block';
  loadProjects();
});

async function openProject(id) {
  try {
    const project = await API.get(`/api/documents/merge-projects/${id}/`);
    currentProject = project;
    document.getElementById('project-list-section').style.display = 'none';
    document.getElementById('project-detail-section').style.display = 'block';
    renderProjectDetail(project);
  } catch(err) {
    showToast('í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
  }
}

function renderProjectDetail(p) {
  const card = document.getElementById('project-info-card');
  const files = p.files || [];
  const status = p.status;

  card.innerHTML = `
    <div class="card-header">
      <h3>${escapeHtml(p.name)}</h3>
      <span>${mergeStatusBadge(status)}</span>
    </div>
    ${p.description ? `<p class="text-muted mb-2">${escapeHtml(p.description)}</p>` : ''}

    <!-- ì›Œí¬í”Œë¡œìš° ìŠ¤í… ì¸ë””ì¼€ì´í„° -->
    <div class="workflow-steps">
      <div class="step ${getStepClass(status, 'upload')}">
        <div class="step-num">1</div>
        <div class="step-label">íŒŒì¼ ì—…ë¡œë“œ</div>
      </div>
      <div class="step-line"></div>
      <div class="step ${getStepClass(status, 'analyze')}">
        <div class="step-num">2</div>
        <div class="step-label">ë¶„ì„</div>
      </div>
      <div class="step-line"></div>
      <div class="step ${getStepClass(status, 'mapping')}">
        <div class="step-num">3</div>
        <div class="step-label">ë§¤í•‘ ì„¤ì •</div>
      </div>
      <div class="step-line"></div>
      <div class="step ${getStepClass(status, 'merge')}">
        <div class="step-num">4</div>
        <div class="step-label">ë³‘í•© ì‹¤í–‰</div>
      </div>
      <div class="step-line"></div>
      <div class="step ${getStepClass(status, 'download')}">
        <div class="step-num">5</div>
        <div class="step-label">ë‹¤ìš´ë¡œë“œ</div>
      </div>
    </div>

    <!-- STEP 1: íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="section">
      <div class="section-header">
        <h4>ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼ (${files.length}ê°œ)</h4>
        ${['draft','ready','failed'].includes(status) ? `
          <label class="btn btn-sm btn-primary" style="cursor:pointer;">
            + íŒŒì¼ ì¶”ê°€
            <input type="file" id="merge-file-input" multiple accept=".xlsx,.xls" style="display:none;">
          </label>
        ` : ''}
      </div>
      ${files.length > 0 ? `
        <div class="file-list">
          ${files.map(f => `
            <div class="file-item">
              <div class="file-info">
                <span class="file-name">${escapeHtml(f.original_filename)}</span>
                <span class="file-meta">${formatSize(f.file_size)} Â· ${f.total_rows > 0 ? f.total_rows + 'í–‰' : 'ë¯¸ë¶„ì„'}</span>
              </div>
              <div class="file-badges">
                ${f.is_analyzed ? '<span class="badge badge-success">ë¶„ì„ë¨</span>' : ''}
                ${f.is_processed ? '<span class="badge badge-success">ì²˜ë¦¬ë¨</span>' : ''}
                ${f.error_message ? '<span class="badge badge-danger" title="'+escapeHtml(f.error_message)+'">ì˜¤ë¥˜</span>' : ''}
              </div>
              ${['draft','ready','failed'].includes(status) ? `<button class="btn btn-xs btn-danger" onclick="removeFile(${p.id}, ${f.id})">âœ•</button>` : ''}
            </div>
          `).join('')}
        </div>
      ` : '<p class="text-muted">íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš” (.xlsx, .xls)</p>'}
    </div>

    <!-- STEP 2: ë¶„ì„ -->
    ${files.length > 0 && ['draft'].includes(status) ? `
      <div class="section">
        <button class="btn btn-primary" id="btn-analyze">ğŸ” íŒŒì¼ ë¶„ì„ ì‹œì‘</button>
        <span class="text-muted" style="margin-left:0.5rem;">í—¤ë” íƒì§€ ë° ì—´ ë§¤í•‘ì„ ìë™ ë¶„ì„í•©ë‹ˆë‹¤</span>
      </div>
    ` : ''}

    <!-- ë¶„ì„ ì§„í–‰ ì¤‘ -->
    ${status === 'analyzing' ? `
      <div class="section">
        <div class="loading-indicator">
          <div class="spinner"></div>
          <span>íŒŒì¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
        </div>
      </div>
    ` : ''}

    <!-- STEP 3: ë§¤í•‘ ì„¤ì • (ë¶„ì„ ì™„ë£Œ í›„) -->
    ${['ready','failed'].includes(status) && p.analysis_result && Object.keys(p.analysis_result).length > 0 ? renderMappingSection(p) : ''}

    <!-- STEP 4: ë³‘í•© ì‹¤í–‰ -->
    ${status === 'ready' ? `
      <div class="section">
        <button class="btn btn-primary btn-lg" id="btn-execute">ğŸš€ ë³‘í•© ì‹¤í–‰</button>
      </div>
    ` : ''}

    ${status === 'merging' ? `
      <div class="section">
        <div class="loading-indicator">
          <div class="spinner"></div>
          <span>íŒŒì¼ì„ ë³‘í•©í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
        </div>
      </div>
    ` : ''}

    <!-- STEP 5: ë‹¤ìš´ë¡œë“œ -->
    ${status === 'completed' ? `
      <div class="section">
        <div class="success-box">
          <h4>âœ… ë³‘í•© ì™„ë£Œ!</h4>
          <p>ì´ ${p.merge_log?.total_rows || '?'}í–‰, ${p.merge_log?.files_succeeded || '?'}ê°œ íŒŒì¼ ì²˜ë¦¬ë¨</p>
          <button class="btn btn-primary btn-lg" onclick="downloadMergedFile(${p.id}, '${escapeHtml(p.name)}')">ğŸ“¥ ë³‘í•© íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn btn-ghost" onclick="saveAsTemplate(${p.id})">ğŸ“‹ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</button>
        </div>
      </div>
      ${p.merge_log?.merge_log ? renderMergeLog(p.merge_log.merge_log) : ''}
    ` : ''}

    <!-- ì˜¤ë¥˜ ìƒíƒœ -->
    ${status === 'failed' && p.error_message ? `
      <div class="error-box">
        <strong>ì˜¤ë¥˜:</strong> ${escapeHtml(p.error_message)}
        <button class="btn btn-sm btn-primary" style="margin-left:1rem;" id="btn-retry">ì¬ì‹œë„</button>
      </div>
    ` : ''}
  `;

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  bindProjectEvents(p);
}

function getStepClass(status, step) {
  const order = { upload: 0, analyze: 1, mapping: 2, merge: 3, download: 4 };
  const statusStep = {
    draft: 0, analyzing: 1, ready: 2, merging: 3, completed: 4, failed: 2
  };
  const current = statusStep[status] ?? 0;
  const target = order[step];
  if (current > target) return 'step-done';
  if (current === target) return 'step-active';
  return '';
}

function renderMappingSection(p) {
  const analysis = p.analysis_result || {};
  const allHeaders = analysis.all_headers || [];
  const suggestions = analysis.suggested_mappings?.individual || {};
  const currentMapping = p.column_mapping || {};
  const dateCols = p.date_columns || [];
  const numberCols = p.number_columns || [];

  let rows = allHeaders.map(h => {
    const sug = suggestions[h] || {};
    const mapped = currentMapping[h] || sug.standard_name || h;
    const conf = sug.confidence ? `(${Math.round(sug.confidence * 100)}%)` : '';
    const isDate = dateCols.includes(mapped);
    const isNumber = numberCols.includes(mapped);
    return `
      <tr>
        <td><code>${escapeHtml(h)}</code></td>
        <td>
          <input type="text" class="form-input form-input-sm mapping-input"
                 data-original="${escapeHtml(h)}" value="${escapeHtml(mapped)}">
          ${conf ? `<small class="text-muted">${conf}</small>` : ''}
        </td>
        <td class="text-center">
          <input type="checkbox" class="date-check" data-col="${escapeHtml(mapped)}" ${isDate ? 'checked' : ''}>
        </td>
        <td class="text-center">
          <input type="checkbox" class="number-check" data-col="${escapeHtml(mapped)}" ${isNumber ? 'checked' : ''}>
        </td>
      </tr>
    `;
  }).join('');

  return `
    <div class="section">
      <div class="section-header">
        <h4>âš™ï¸ ì—´ ë§¤í•‘ ì„¤ì •</h4>
        <button class="btn btn-sm btn-ghost" id="btn-apply-template">ğŸ“‹ í…œí”Œë¦¿ ì ìš©</button>
      </div>
      <p class="text-muted">ì›ë³¸ ì—´ ì´ë¦„ì„ í‘œì¤€ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•©ë‹ˆë‹¤. ë‚ ì§œ/ìˆ«ì ì—´ì„ ì²´í¬í•˜ë©´ ìë™ ì •ê·œí™”ë©ë‹ˆë‹¤.</p>
      <div class="table-wrap" style="max-height:400px; overflow:auto;">
        <table class="table table-sm">
          <thead>
            <tr><th>ì›ë³¸ ì—´ ì´ë¦„</th><th>ë§¤í•‘ â†’ í‘œì¤€ ì´ë¦„</th><th>ë‚ ì§œ</th><th>ìˆ«ì</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div style="margin-top:1rem;">
        <button class="btn btn-primary" id="btn-save-mapping">ğŸ’¾ ë§¤í•‘ ì €ì¥</button>
      </div>
    </div>
  `;
}

function renderMergeLog(log) {
  if (!log || log.length === 0) return '';
  return `
    <div class="section">
      <h4>ğŸ“ ë³‘í•© ë¡œê·¸</h4>
      <div class="table-wrap">
        <table class="table table-sm">
          <thead><tr><th>íŒŒì¼</th><th>ìƒíƒœ</th><th>ì²˜ë¦¬ëœ í–‰</th><th>ì˜¤ë¥˜</th></tr></thead>
          <tbody>
            ${log.map(l => `
              <tr>
                <td>${escapeHtml(l.file || '')}</td>
                <td>${l.status === 'success' ? '<span class="badge badge-success">ì„±ê³µ</span>' : '<span class="badge badge-danger">ì‹¤íŒ¨</span>'}</td>
                <td>${l.rows_processed || '-'}</td>
                <td>${l.error ? escapeHtml(l.error) : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function mergeStatusBadge(s) {
  const map = {
    draft: ['ì´ˆì•ˆ', 'badge-gray'],
    analyzing: ['ë¶„ì„ì¤‘', 'badge-info'],
    ready: ['ì¤€ë¹„ë¨', 'badge-warning'],
    merging: ['ë³‘í•©ì¤‘', 'badge-info'],
    completed: ['ì™„ë£Œ', 'badge-success'],
    failed: ['ì‹¤íŒ¨', 'badge-danger'],
  };
  const [label, cls] = map[s] || [s, 'badge-gray'];
  return `<span class="badge ${cls}">${label}</span>`;
}

function bindProjectEvents(p) {
  // íŒŒì¼ ì—…ë¡œë“œ
  const fileInput = document.getElementById('merge-file-input');
  if (fileInput) {
    fileInput.addEventListener('change', async (e) => {
      const files = e.target.files;
      if (files.length === 0) return;
      const formData = new FormData();
      for (const f of files) formData.append('files', f);

      try {
        await API.upload(`/api/documents/merge-projects/${p.id}/upload_files/`, formData);
        showToast(`${files.length}ê°œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ`);
        openProject(p.id);
      } catch(err) {
        showToast(err.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
      }
    });
  }

  // ë¶„ì„ ì‹œì‘
  const btnAnalyze = document.getElementById('btn-analyze');
  if (btnAnalyze) {
    btnAnalyze.addEventListener('click', async () => {
      try {
        await API.post(`/api/documents/merge-projects/${p.id}/analyze/`);
        showToast('ë¶„ì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
        // í´ë§ ì‹œì‘
        pollProjectStatus(p.id);
      } catch(err) {
        showToast(err.message || 'ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨', 'error');
      }
    });
  }

  // ë§¤í•‘ ì €ì¥
  const btnSaveMapping = document.getElementById('btn-save-mapping');
  if (btnSaveMapping) {
    btnSaveMapping.addEventListener('click', async () => {
      const mappingInputs = document.querySelectorAll('.mapping-input');
      const columnMapping = {};
      mappingInputs.forEach(inp => {
        const original = inp.dataset.original;
        const standard = inp.value.trim();
        if (original && standard && original !== standard) {
          columnMapping[original] = standard;
        }
      });

      const dateColumns = [];
      document.querySelectorAll('.date-check:checked').forEach(cb => dateColumns.push(cb.dataset.col));
      const numberColumns = [];
      document.querySelectorAll('.number-check:checked').forEach(cb => numberColumns.push(cb.dataset.col));

      try {
        await API.put(`/api/documents/merge-projects/${p.id}/update_mapping/`, {
          column_mapping: columnMapping,
          date_columns: dateColumns,
          number_columns: numberColumns,
        });
        showToast('ë§¤í•‘ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        openProject(p.id);
      } catch(err) {
        showToast(err.message || 'ì €ì¥ ì‹¤íŒ¨', 'error');
      }
    });
  }

  // ë³‘í•© ì‹¤í–‰
  const btnExecute = document.getElementById('btn-execute');
  if (btnExecute) {
    btnExecute.addEventListener('click', async () => {
      try {
        await API.post(`/api/documents/merge-projects/${p.id}/execute/`);
        showToast('ë³‘í•©ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
        pollProjectStatus(p.id);
      } catch(err) {
        showToast(err.message || 'ë³‘í•© ì‹œì‘ ì‹¤íŒ¨', 'error');
      }
    });
  }

  // ì¬ì‹œë„
  const btnRetry = document.getElementById('btn-retry');
  if (btnRetry) {
    btnRetry.addEventListener('click', async () => {
      try {
        await API.post(`/api/documents/merge-projects/${p.id}/execute/`);
        showToast('ì¬ì‹œë„ ì‹œì‘');
        pollProjectStatus(p.id);
      } catch(err) {
        showToast(err.message || 'ì‹¤íŒ¨', 'error');
      }
    });
  }

  // í…œí”Œë¦¿ ì ìš©
  const btnTemplate = document.getElementById('btn-apply-template');
  if (btnTemplate) {
    btnTemplate.addEventListener('click', () => applyTemplateModal(p.id));
  }
}

async function removeFile(projectId, fileId) {
  if (!confirm('ì´ íŒŒì¼ì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await API.delete(`/api/documents/merge-projects/${projectId}/files/${fileId}/`);
    showToast('íŒŒì¼ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
    openProject(projectId);
  } catch(err) {
    showToast('ì œê±° ì‹¤íŒ¨', 'error');
  }
}

async function downloadMergedFile(projectId, projectName) {
  try {
    const token = API.getToken();
    if (!token) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
    let resp = await fetch(`/api/documents/merge-projects/${projectId}/download/`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    // í† í° ë§Œë£Œ ì‹œ ê°±ì‹  í›„ ì¬ì‹œë„
    if (resp.status === 401) {
      await API.refreshToken();
      const newToken = API.getToken();
      resp = await fetch(`/api/documents/merge-projects/${projectId}/download/`, {
        headers: { 'Authorization': `Bearer ${newToken}` }
      });
    }
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.error || err.detail || 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
    }
    const blob = await resp.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${projectName}_ë³‘í•©ê²°ê³¼.xlsx`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  } catch(err) {
    showToast(err.message || 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'error');
  }
}

async function saveAsTemplate(projectId) {
  showModal('í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥', `
    <form id="save-template-form">
      <div class="form-group">
        <label>í…œí”Œë¦¿ ì´ë¦„</label>
        <input type="text" id="tpl-name" class="form-input" required>
      </div>
      <button type="submit" class="btn btn-primary btn-full">ì €ì¥</button>
    </form>
  `);
  document.getElementById('save-template-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      await API.post(`/api/documents/merge-projects/${projectId}/save_as_template/`, {
        name: document.getElementById('tpl-name').value,
      });
      closeModal();
      showToast('í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    } catch(err) {
      showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
    }
  });
}

async function applyTemplateModal(projectId) {
  try {
    const data = await API.get('/api/documents/mapping-templates/');
    const templates = data.results || [];
    if (templates.length === 0) {
      showToast('ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤', 'warning');
      return;
    }
    showModal('í…œí”Œë¦¿ ì ìš©', `
      <div class="template-list">
        ${templates.map(t => `
          <div class="template-item" onclick="applyTemplate(${projectId}, ${t.id})" style="cursor:pointer;">
            <strong>${escapeHtml(t.name)}</strong>
            <small class="text-muted">${escapeHtml(t.description || '')}</small>
          </div>
        `).join('')}
      </div>
    `);
  } catch(err) {
    showToast('í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
  }
}

async function applyTemplate(projectId, templateId) {
  try {
    await API.post(`/api/documents/merge-projects/${projectId}/apply_template/`, {
      template_id: templateId,
    });
    closeModal();
    showToast('í…œí”Œë¦¿ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤');
    openProject(projectId);
  } catch(err) {
    showToast('ì ìš© ì‹¤íŒ¨', 'error');
  }
}

function pollProjectStatus(projectId) {
  const interval = setInterval(async () => {
    try {
      const p = await API.get(`/api/documents/merge-projects/${projectId}/`);
      if (!['analyzing', 'merging'].includes(p.status)) {
        clearInterval(interval);
        openProject(projectId);
      }
    } catch(err) {
      clearInterval(interval);
    }
  }, 2000);
}

document.addEventListener('DOMContentLoaded', loadProjects);
</script>
{% endblock %}
