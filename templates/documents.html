{% extends "base.html" %}
{% block title %}ë¬¸ì„œ ê´€ë¦¬ - DocMerge{% endblock %}
{% block nav_documents %}active{% endblock %}
{% block page_title %}ë¬¸ì„œ ê´€ë¦¬{% endblock %}

{% block top_actions %}
<button class="btn btn-primary" id="btn-upload">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
{% endblock %}

{% block content %}
<!-- í•„í„° -->
<div class="filter-bar">
  <select id="filter-type" class="form-select">
    <option value="">ì „ì²´ ìœ í˜•</option>
    <option value="excel">ì—‘ì…€</option>
    <option value="pdf">PDF</option>
    <option value="image">ì´ë¯¸ì§€</option>
  </select>
  <select id="filter-status" class="form-select">
    <option value="">ì „ì²´ ìƒíƒœ</option>
    <option value="pending">ëŒ€ê¸°ì¤‘</option>
    <option value="processing">ì²˜ë¦¬ì¤‘</option>
    <option value="completed">ì™„ë£Œ</option>
    <option value="failed">ì‹¤íŒ¨</option>
  </select>
  <input type="text" id="filter-search" class="form-input" placeholder="íŒŒì¼ëª… ê²€ìƒ‰...">
</div>

<!-- ë¬¸ì„œ í…Œì´ë¸” -->
<div class="table-wrap">
  <table class="table">
    <thead>
      <tr>
        <th>íŒŒì¼ëª…</th>
        <th>ìœ í˜•</th>
        <th>ìƒíƒœ</th>
        <th>í¬ê¸°</th>
        <th>ì—…ë¡œë“œì¼</th>
        <th>ì‘ì—…</th>
      </tr>
    </thead>
    <tbody id="docs-body">
      <tr><td colspan="6" class="empty-state">ë¡œë”© ì¤‘...</td></tr>
    </tbody>
  </table>
</div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
<div class="pagination" id="pagination"></div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentPage = 1;

async function loadDocuments(page = 1) {
  const type = document.getElementById('filter-type').value;
  const status = document.getElementById('filter-status').value;
  const search = document.getElementById('filter-search').value;

  let url = `/api/documents/documents/?page=${page}`;
  if (type) url += `&file_type=${type}`;
  if (status) url += `&status=${status}`;
  if (search) url += `&search=${encodeURIComponent(search)}`;

  try {
    const data = await API.get(url);
    const results = data.results || [];
    const tbody = document.getElementById('docs-body');

    if (results.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="empty-state">ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    } else {
      tbody.innerHTML = results.map(d => `
        <tr>
          <td><strong>${escapeHtml(d.original_filename)}</strong></td>
          <td><span class="badge badge-type">${d.file_type}</span></td>
          <td>${statusBadge(d.status)}</td>
          <td>${formatSize(d.file_size)}</td>
          <td>${formatDate(d.created_at)}</td>
          <td class="actions">
            ${d.status === 'completed' ? `<a href="/app/documents/${d.id}/" class="btn btn-xs btn-primary">ğŸ“Š ê±°ë˜ë‚´ì—­</a>` : ''}
            ${d.status === 'completed' ? `<button class="btn btn-xs btn-ghost" onclick="viewExtracted(${d.id})">ğŸ‘ ë¯¸ë¦¬ë³´ê¸°</button>` : ''}
            ${d.status === 'failed' ? `<button class="btn btn-xs btn-ghost" onclick="reprocess(${d.id})">ğŸ”„ ì¬ì²˜ë¦¬</button>` : ''}
            <button class="btn btn-xs btn-danger" onclick="deleteDoc(${d.id})">ğŸ—‘</button>
          </td>
        </tr>
      `).join('');
    }

    // í˜ì´ì§€ë„¤ì´ì…˜
    renderPagination(data, page);
    currentPage = page;
  } catch (err) {
    console.error(err);
    showToast('ë¬¸ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
  }
}

function renderPagination(data, page) {
  const pag = document.getElementById('pagination');
  const total = data.count || 0;
  const pages = Math.ceil(total / 20);
  if (pages <= 1) { pag.innerHTML = ''; return; }

  let html = '';
  for (let i = 1; i <= pages; i++) {
    html += `<button class="btn btn-sm ${i === page ? 'btn-primary' : 'btn-ghost'}" onclick="loadDocuments(${i})">${i}</button> `;
  }
  pag.innerHTML = html;
}

// ì—…ë¡œë“œ ëª¨ë‹¬
document.getElementById('btn-upload').addEventListener('click', () => {
  showModal('íŒŒì¼ ì—…ë¡œë“œ', `
    <form id="upload-form">
      <div class="form-group">
        <label>íŒŒì¼ ì„ íƒ</label>
        <input type="file" id="upload-file" accept=".xlsx,.xls,.pdf,.jpg,.jpeg,.png" required>
      </div>
      <div class="form-group">
        <label>íŒŒì¼ ìœ í˜•</label>
        <select id="upload-type" class="form-select" required>
          <option value="excel">ì—‘ì…€</option>
          <option value="pdf">PDF</option>
          <option value="image">ì´ë¯¸ì§€</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary btn-full">ì—…ë¡œë“œ</button>
    </form>
  `);

  document.getElementById('upload-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const file = document.getElementById('upload-file').files[0];
    const fileType = document.getElementById('upload-type').value;
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('file_type', fileType);

    try {
      await API.upload('/api/documents/documents/', formData);
      closeModal();
      showToast('íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
      loadDocuments(currentPage);
    } catch (err) {
      showToast(err.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
    }
  });
});

async function viewExtracted(docId) {
  try {
    const data = await API.get(`/api/documents/documents/${docId}/extracted_data/`);
    showModal('ì¶”ì¶œ ë°ì´í„°', `
      <div class="detail-grid">
        <div class="detail-item"><span class="detail-label">ì´ í–‰ ìˆ˜</span><span class="detail-value">${data.total_rows || 0}</span></div>
        <div class="detail-item"><span class="detail-label">ì´ í˜ì´ì§€</span><span class="detail-value">${data.total_pages || 0}</span></div>
        <div class="detail-item"><span class="detail-label">í…ìŠ¤íŠ¸ ê¸¸ì´</span><span class="detail-value">${(data.extracted_text || '').length.toLocaleString()}ì</span></div>
      </div>
      ${data.structured_data && data.structured_data.headers ? `
        <h4 style="margin-top:1rem;">êµ¬ì¡°í™” ë°ì´í„°</h4>
        <div class="table-wrap" style="max-height:300px; overflow:auto;">
          <table class="table table-sm">
            <thead><tr>${data.structured_data.headers.map(h => `<th>${escapeHtml(String(h || ''))}</th>`).join('')}</tr></thead>
            <tbody>${(data.structured_data.rows || []).slice(0, 20).map(row =>
              `<tr>${row.map(cell => `<td>${escapeHtml(String(cell ?? ''))}</td>`).join('')}</tr>`
            ).join('')}</tbody>
          </table>
          ${(data.structured_data.rows || []).length > 20 ? '<p class="text-muted">... ì²˜ìŒ 20í–‰ë§Œ í‘œì‹œ</p>' : ''}
        </div>
      ` : ''}
    `);
  } catch (err) {
    showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
  }
}

async function reprocess(docId) {
  try {
    await API.post(`/api/documents/documents/${docId}/reprocess/`);
    showToast('ì¬ì²˜ë¦¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
    loadDocuments(currentPage);
  } catch (err) {
    showToast('ì¬ì²˜ë¦¬ ìš”ì²­ ì‹¤íŒ¨', 'error');
  }
}

async function deleteDoc(docId) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await API.delete(`/api/documents/documents/${docId}/`);
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    loadDocuments(currentPage);
  } catch (err) {
    showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
  }
}

// í•„í„° ì´ë²¤íŠ¸
document.getElementById('filter-type').addEventListener('change', () => loadDocuments(1));
document.getElementById('filter-status').addEventListener('change', () => loadDocuments(1));
let searchTimer;
document.getElementById('filter-search').addEventListener('input', () => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => loadDocuments(1), 400);
});

document.addEventListener('DOMContentLoaded', () => loadDocuments(1));
</script>
{% endblock %}
