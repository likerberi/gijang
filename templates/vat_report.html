{% extends "base.html" %}
{% block title %}ë¶€ê°€ì„¸ ì‹ ê³ ì„œ - ê¸°ì¥{% endblock %}
{% block nav_documents %}active{% endblock %}
{% block page_title %}ë¶€ê°€ì„¸ ì‹ ê³ ì„œ{% endblock %}

{% block top_actions %}
<button class="btn btn-ghost" onclick="location.href='/app/documents/{{ doc_id }}/'">â† ê±°ë˜ë‚´ì—­</button>
<button class="btn btn-primary" id="btn-download-vat">ğŸ“¥ ë¶€ê°€ì„¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
{% endblock %}

{% block extra_head %}
<style>
.vat-header { display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; }
.vat-period { display: flex; gap: .5rem; align-items: center; }
.vat-period select { height: 36px; padding: 0 .75rem; border: 1px solid var(--c-gray-200); border-radius: 8px; font-size: .9rem; }

.vat-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
.vat-card { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 4px rgba(0,0,0,.06); text-align: center; }
.vat-card.sales { border-top: 4px solid #10b981; }
.vat-card.purchase { border-top: 4px solid #ef4444; }
.vat-card.payable { border-top: 4px solid #2563eb; }
.vat-card .card-label { font-size: .85rem; color: var(--c-gray-500); margin-bottom: .5rem; }
.vat-card .card-amount { font-size: 1.1rem; margin-bottom: .25rem; }
.vat-card .card-vat { font-size: 1.8rem; font-weight: 700; }
.vat-card.sales .card-vat { color: #10b981; }
.vat-card.purchase .card-vat { color: #ef4444; }
.vat-card.payable .card-vat { color: #2563eb; }

.vat-detail { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
.vat-section { background: #fff; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
.vat-section h4 { margin: 0 0 1rem; font-size: 1rem; display: flex; align-items: center; gap: .5rem; }
.vat-table { width: 100%; border-collapse: collapse; font-size: .85rem; }
.vat-table th { background: #f8fafc; padding: .6rem .5rem; text-align: left; border-bottom: 2px solid var(--c-gray-200); }
.vat-table td { padding: .5rem; border-bottom: 1px solid var(--c-gray-100); }
.vat-table td.num { text-align: right; font-variant-numeric: tabular-nums; }
.cat-badge { font-size: .75rem; padding: .15rem .4rem; border-radius: 4px; background: #e0e7ff; color: #3730a3; }

.payable-box { background: #fff; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,.08); text-align: center; margin-bottom: 1.5rem; }
.payable-box .pb-label { font-size: 1rem; color: var(--c-gray-500); margin-bottom: .5rem; }
.payable-box .pb-amount { font-size: 2.5rem; font-weight: 800; color: #2563eb; }
.payable-box .pb-formula { font-size: .9rem; color: var(--c-gray-400); margin-top: .5rem; }

@media (max-width: 768px) {
  .vat-summary { grid-template-columns: 1fr; }
  .vat-detail { grid-template-columns: 1fr; }
}
</style>
{% endblock %}

{% block content %}
<!-- ê¸°ê°„ ì„ íƒ -->
<div class="vat-header">
  <div class="vat-period">
    <select id="vat-year"></select>
    <select id="vat-quarter">
      <option value="">ì „ì²´</option>
      <option value="1">1ê¸° (1~3ì›”)</option>
      <option value="2">2ê¸° (4~6ì›”)</option>
      <option value="3">3ê¸° (7~9ì›”)</option>
      <option value="4">4ê¸° (10~12ì›”)</option>
    </select>
    <button class="btn btn-primary btn-sm" onclick="loadVAT()">ì¡°íšŒ</button>
  </div>
  <span class="text-muted" style="font-size:.85rem;" id="vat-period-label"></span>
</div>

<!-- ë‚©ë¶€ ì„¸ì•¡ -->
<div class="payable-box" id="payable-box" style="display:none;">
  <div class="pb-label" id="pb-label">ë‚©ë¶€í•  ì„¸ì•¡</div>
  <div class="pb-amount" id="pb-amount">-</div>
  <div class="pb-formula" id="pb-formula"></div>
</div>

<!-- ë§¤ì¶œ/ë§¤ì…/ë‚©ë¶€ ì„¸ì•¡ ì¹´ë“œ -->
<div class="vat-summary" id="vat-summary" style="display:none;">
  <div class="vat-card sales">
    <div class="card-label">ë§¤ì¶œ ì„¸ì•¡</div>
    <div class="card-amount" id="sales-supply">ê³µê¸‰ê°€ì•¡: -</div>
    <div class="card-vat" id="sales-vat">-</div>
  </div>
  <div class="vat-card purchase">
    <div class="card-label">ë§¤ì… ì„¸ì•¡</div>
    <div class="card-amount" id="purchase-supply">ê³µê¸‰ê°€ì•¡: -</div>
    <div class="card-vat" id="purchase-vat">-</div>
  </div>
  <div class="vat-card payable">
    <div class="card-label">ë§¤ì¶œ ê±´ìˆ˜ / ë§¤ì… ê±´ìˆ˜</div>
    <div class="card-vat" id="vat-counts">- / -</div>
  </div>
</div>

<!-- ë§¤ì… ì¹´í…Œê³ ë¦¬ë³„ -->
<div class="vat-detail" id="vat-detail" style="display:none;">
  <div class="vat-section">
    <h4>ğŸ“ˆ ë§¤ì¶œ ìƒìœ„ ë‚´ì—­</h4>
    <div style="overflow-x:auto; max-height:400px;">
      <table class="vat-table" id="sales-table">
        <thead><tr><th>ë‚ ì§œ</th><th>ì ìš”</th><th>ê³„ì •ê³¼ëª©</th><th style="text-align:right">ê¸ˆì•¡</th><th style="text-align:right">ì„¸ì•¡</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="vat-section">
    <h4>ğŸ“‰ ë§¤ì… ì¹´í…Œê³ ë¦¬ë³„ í•©ê³„</h4>
    <div style="overflow-x:auto; max-height:400px;">
      <table class="vat-table" id="purchase-cat-table">
        <thead><tr><th>ê³„ì •ê³¼ëª©</th><th style="text-align:right">ê±´ìˆ˜</th><th style="text-align:right">ê¸ˆì•¡</th><th style="text-align:right">ì„¸ì•¡</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div id="loading" class="empty-state">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
{% endblock %}

{% block extra_scripts %}
<script>
const DOC_ID = {{ doc_id }};

function money(v) {
  if (v == null || isNaN(v)) return '-';
  return Math.round(v).toLocaleString() + 'ì›';
}

// ì—°ë„ ì…€ë ‰íŠ¸ ì´ˆê¸°í™”
(function() {
  const sel = document.getElementById('vat-year');
  const thisYear = new Date().getFullYear();
  for (let y = thisYear; y >= thisYear - 3; y--) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y + 'ë…„';
    sel.appendChild(opt);
  }
})();

async function loadVAT() {
  const year = document.getElementById('vat-year').value;
  const quarter = document.getElementById('vat-quarter').value;
  
  let url = `/api/documents/documents/${DOC_ID}/vat_report/?year=${year}`;
  if (quarter) url += `&quarter=${quarter}`;
  
  document.getElementById('loading').style.display = 'block';
  
  try {
    const d = await API.get(url);
    document.getElementById('loading').style.display = 'none';
    
    // ê¸°ê°„ í‘œì‹œ
    document.getElementById('vat-period-label').textContent = d.period.description;
    
    // ë‚©ë¶€ ì„¸ì•¡
    const box = document.getElementById('payable-box');
    box.style.display = 'block';
    const payable = d.summary.payable_vat;
    document.getElementById('pb-label').textContent = payable >= 0 ? 'ë‚©ë¶€í•  ì„¸ì•¡' : 'í™˜ê¸‰ë°›ì„ ì„¸ì•¡';
    document.getElementById('pb-amount').textContent = money(Math.abs(payable));
    document.getElementById('pb-amount').style.color = payable >= 0 ? '#2563eb' : '#10b981';
    document.getElementById('pb-formula').textContent = 
      `ë§¤ì¶œì„¸ì•¡ ${money(d.summary.sales_vat)} - ë§¤ì…ì„¸ì•¡ ${money(d.summary.purchase_vat)}`;
    
    // ì¹´ë“œ
    document.getElementById('vat-summary').style.display = 'grid';
    document.getElementById('sales-supply').textContent = 'ê³µê¸‰ê°€ì•¡: ' + money(d.sales.supply_value);
    document.getElementById('sales-vat').textContent = money(d.sales.vat);
    document.getElementById('purchase-supply').textContent = 'ê³µê¸‰ê°€ì•¡: ' + money(d.purchases.supply_value);
    document.getElementById('purchase-vat').textContent = money(d.purchases.vat);
    document.getElementById('vat-counts').textContent = `${d.sales.count}ê±´ / ${d.purchases.count}ê±´`;
    
    // ìƒì„¸
    document.getElementById('vat-detail').style.display = 'grid';
    
    // ë§¤ì¶œ ìƒìœ„ ë‚´ì—­
    const salesTbody = document.querySelector('#sales-table tbody');
    const salesItems = (d.sales.items || []).sort((a, b) => b.amount - a.amount).slice(0, 20);
    salesTbody.innerHTML = salesItems.map(item => `
      <tr>
        <td>${escapeHtml(item.date)}</td>
        <td>${escapeHtml(item.description)}</td>
        <td><span class="cat-badge">${escapeHtml(item.category)}</span></td>
        <td class="num">${money(item.amount)}</td>
        <td class="num">${money(item.vat)}</td>
      </tr>
    `).join('') || '<tr><td colspan="5" class="empty-state">ë§¤ì¶œ ë°ì´í„° ì—†ìŒ</td></tr>';
    
    // ë§¤ì… ì¹´í…Œê³ ë¦¬ë³„
    const purchCatTbody = document.querySelector('#purchase-cat-table tbody');
    const cats = d.purchases.by_category || {};
    const catEntries = Object.entries(cats).sort((a,b) => b[1].amount - a[1].amount);
    purchCatTbody.innerHTML = catEntries.map(([cat, info]) => `
      <tr>
        <td><span class="cat-badge">${escapeHtml(cat)}</span></td>
        <td class="num">${info.count}</td>
        <td class="num">${money(info.amount)}</td>
        <td class="num">${money(info.vat)}</td>
      </tr>
    `).join('') || '<tr><td colspan="4" class="empty-state">ë§¤ì… ë°ì´í„° ì—†ìŒ</td></tr>';
    
  } catch(err) {
    document.getElementById('loading').innerHTML = `<span style="color:#ef4444;">ì˜¤ë¥˜: ${err.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨'}</span>`;
  }
}

// ë‹¤ìš´ë¡œë“œ
document.getElementById('btn-download-vat').addEventListener('click', async () => {
  try {
    const year = document.getElementById('vat-year').value;
    const quarter = document.getElementById('vat-quarter').value;
    
    let url = `/api/documents/documents/${DOC_ID}/vat_download/?year=${year}`;
    if (quarter) url += `&quarter=${quarter}`;
    
    const token = API.getToken();
    let resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
    if (resp.status === 401) {
      await API.refreshToken();
      resp = await fetch(url, { headers: { 'Authorization': `Bearer ${API.getToken()}` } });
    }
    if (!resp.ok) throw new Error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
    
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ë¶€ê°€ì„¸ì‹ ê³ _${DOC_ID}.xlsx`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    showToast('ë¶€ê°€ì„¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
  } catch(err) {
    showToast(err.message || 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'error');
  }
});

document.addEventListener('DOMContentLoaded', loadVAT);
</script>
{% endblock %}
