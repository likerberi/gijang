{% extends "base.html" %}
{% block title %}ê±°ë˜ë‚´ì—­ - ê¸°ì¥{% endblock %}
{% block nav_documents %}active{% endblock %}
{% block page_title %}ê±°ë˜ë‚´ì—­ ìƒì„¸{% endblock %}

{% block top_actions %}
<button class="btn btn-ghost" onclick="location.href='/app/documents/'">â† ë¬¸ì„œ ëª©ë¡</button>
<button class="btn btn-ghost" onclick="location.href='/app/documents/{{ doc_id }}/vat/'">ğŸ§¾ ë¶€ê°€ì„¸</button>
<button class="btn btn-ghost" onclick="location.href='/app/documents/{{ doc_id }}/monthly/'">ğŸ“ˆ ì›”ë³„ ë¦¬í¬íŠ¸</button>
<button class="btn btn-ghost" id="btn-extract-vendors">ğŸ¢ ê±°ë˜ì²˜ ì¶”ì¶œ</button>
<button class="btn btn-primary" id="btn-download">ğŸ“¥ ê¸°ì¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
{% endblock %}

{% block extra_head %}
<style>
/* ì¬ë¬´ ìš”ì•½ ì¹´ë“œ */
.fin-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.fin-card { background: #fff; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,.06); border-left: 4px solid var(--c-gray-200); }
.fin-card.income { border-left-color: #10b981; }
.fin-card.expense { border-left-color: #ef4444; }
.fin-card.net { border-left-color: #2563eb; }
.fin-card.count { border-left-color: #8b5cf6; }
.fin-card .fin-label { font-size: .8rem; color: var(--c-gray-500); margin-bottom: .25rem; }
.fin-card .fin-value { font-size: 1.5rem; font-weight: 700; }
.fin-card.income .fin-value { color: #10b981; }
.fin-card.expense .fin-value { color: #ef4444; }
.fin-card.net .fin-value { color: #2563eb; }

/* ì¹´í…Œê³ ë¦¬ ë¶„ì„ */
.category-section { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
.category-table-wrap { background: #fff; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
.category-table-wrap h4 { margin: 0 0 .75rem; font-size: 1rem; }

/* ë°ì´í„° í…Œì´ë¸” ì„¹ì…˜ */
.data-section { background: #fff; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
.data-toolbar { display: flex; gap: .75rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; }
.data-toolbar .form-input, .data-toolbar .form-select { height: 36px; font-size: .85rem; }
.data-toolbar .search-input { flex: 1; min-width: 200px; }
.data-info { font-size: .8rem; color: var(--c-gray-500); margin-left: auto; white-space: nowrap; }

/* ê±°ë˜ í…Œì´ë¸” */
#data-table { width: 100%; border-collapse: collapse; font-size: .85rem; }
#data-table thead th {
  background: #f8fafc; border-bottom: 2px solid var(--c-gray-200);
  padding: .6rem .5rem; text-align: left; cursor: pointer; white-space: nowrap;
  position: sticky; top: 0; z-index: 1;
  user-select: none;
}
#data-table thead th:hover { background: #e2e8f0; }
#data-table thead th .sort-icon { margin-left: .25rem; font-size: .7rem; }
#data-table tbody td { padding: .5rem; border-bottom: 1px solid var(--c-gray-100); }
#data-table tbody tr:hover { background: #f1f5f9; }
.cell-number { text-align: right; font-variant-numeric: tabular-nums; }
.cell-category { font-size: .75rem; padding: .2rem .5rem; border-radius: 4px; background: #e0e7ff; color: #3730a3; white-space: nowrap; }
.cell-category.unclassified { background: #fef3c7; color: #92400e; }

/* í˜ì´ì§€ë„¤ì´ì…˜ */
.pag { display: flex; justify-content: center; gap: .25rem; margin-top: 1rem; }
.pag button { min-width: 36px; height: 36px; border: 1px solid var(--c-gray-200); border-radius: 6px; background: #fff; cursor: pointer; font-size: .85rem; }
.pag button.active { background: var(--c-primary); color: #fff; border-color: var(--c-primary); }
.pag button:disabled { opacity: .5; cursor: not-allowed; }

/* ì—´ ê°ì§€ ì•Œë¦¼ */
.detect-alert { background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 8px; padding: .75rem 1rem; margin-bottom: 1rem; font-size: .85rem; color: #065f46; }
.detect-alert strong { color: #047857; }
.no-financial { background: #fef3c7; border-color: #fcd34d; color: #92400e; }
.no-financial strong { color: #78350f; }

/* ë°” ì°¨íŠ¸ */
.bar-wrap { display: flex; align-items: center; gap: .5rem; margin-bottom: .35rem; }
.bar-label { font-size: .8rem; min-width: 80px; text-align: right; }
.bar { height: 20px; border-radius: 4px; min-width: 2px; }
.bar-income { background: #10b981; }
.bar-expense { background: #ef4444; }
.bar-val { font-size: .75rem; color: var(--c-gray-500); }

/* ê³„ì •ê³¼ëª© ìˆ˜ì • */
.cell-category { cursor: pointer; transition: all .15s; }
.cell-category:hover { filter: brightness(.9); transform: scale(1.05); }
.cell-category.user-classified { background: #c7d2fe; color: #312e81; border: 1px solid #818cf8; }
.cat-select { font-size: .75rem; padding: .15rem .3rem; border: 1px solid var(--c-primary); border-radius: 4px; background: #fff; max-width: 120px; }

@media (max-width: 768px) {
  .fin-summary { grid-template-columns: 1fr 1fr; }
  .category-section { grid-template-columns: 1fr; }
  .data-toolbar { flex-direction: column; }
  .data-info { margin-left: 0; }
}
</style>
{% endblock %}

{% block content %}
<div id="doc-info" style="margin-bottom:.5rem;"></div>

<!-- ì¬ë¬´ ìš”ì•½ ì¹´ë“œ -->
<div class="fin-summary" id="fin-summary" style="display:none;">
  <div class="fin-card income">
    <div class="fin-label">ì´ ì…ê¸ˆ</div>
    <div class="fin-value" id="fin-income">-</div>
  </div>
  <div class="fin-card expense">
    <div class="fin-label">ì´ ì¶œê¸ˆ</div>
    <div class="fin-value" id="fin-expense">-</div>
  </div>
  <div class="fin-card net">
    <div class="fin-label">ìˆœì´ìµ</div>
    <div class="fin-value" id="fin-net">-</div>
  </div>
  <div class="fin-card count">
    <div class="fin-label">ê±°ë˜ ê±´ìˆ˜</div>
    <div class="fin-value" id="fin-count">-</div>
  </div>
</div>

<!-- ì—´ ê°ì§€ ì•Œë¦¼ -->
<div id="detect-msg"></div>

<!-- ì¹´í…Œê³ ë¦¬ ë¶„ì„ -->
<div class="category-section" id="category-section" style="display:none;">
  <div class="category-table-wrap">
    <h4>ğŸ“Š ê³„ì •ê³¼ëª©ë³„ ìš”ì•½</h4>
    <div id="category-table-body"></div>
  </div>
  <div class="category-table-wrap">
    <h4>ğŸ“ˆ ê³„ì •ê³¼ëª©ë³„ ë¹„êµ</h4>
    <div id="category-chart"></div>
  </div>
</div>

<!-- ë°ì´í„° í…Œì´ë¸” -->
<div class="data-section">
  <div class="data-toolbar">
    <input type="text" class="form-input search-input" id="search-input" placeholder="ğŸ” ê±°ë˜ë‚´ìš© ê²€ìƒ‰...">
    <select class="form-select" id="category-filter">
      <option value="">ì „ì²´ ê³„ì •ê³¼ëª©</option>
    </select>
    <select class="form-select" id="page-size-select">
      <option value="50">50í–‰</option>
      <option value="100">100í–‰</option>
      <option value="200">200í–‰</option>
      <option value="500">500í–‰</option>
    </select>
    <span class="data-info" id="data-info">-</span>
  </div>
  <div style="overflow-x:auto; max-height: 70vh;">
    <table id="data-table">
      <thead id="data-thead"><tr><th>ë¡œë”© ì¤‘...</th></tr></thead>
      <tbody id="data-tbody"><tr><td class="empty-state">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr></tbody>
    </table>
  </div>
  <div class="pag" id="pagination"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const DOC_ID = {{ doc_id }};
let currentPage = 1;
let pageSize = 50;
let sortCol = '';
let sortDir = 'asc';
let searchQuery = '';
let categoryFilter = '';
let allHeaders = [];
let financialCols = {};
let userClassifications = {};

function money(v) {
  if (v == null || isNaN(v)) return '-';
  return Math.round(v).toLocaleString() + 'ì›';
}

async function loadData() {
  let url = `/api/documents/documents/${DOC_ID}/data/?page=${currentPage}&page_size=${pageSize}`;
  if (searchQuery) url += `&search=${encodeURIComponent(searchQuery)}`;
  if (sortCol !== '') url += `&sort_col=${sortCol}&sort_dir=${sortDir}`;
  if (categoryFilter) url += `&category=${encodeURIComponent(categoryFilter)}`;

  try {
    const d = await API.get(url);
    allHeaders = d.headers || [];
    financialCols = d.financial_columns || {};

    // ì¬ë¬´ ìš”ì•½
    const fs = d.financial_summary;
    if (fs) {
      document.getElementById('fin-summary').style.display = 'grid';
      document.getElementById('fin-income').textContent = money(fs.total_income);
      document.getElementById('fin-expense').textContent = money(fs.total_expense);
      document.getElementById('fin-net').textContent = money(fs.net);
      document.getElementById('fin-count').textContent = fs.transaction_count.toLocaleString() + 'ê±´';

      // ì—´ ê°ì§€ ë©”ì‹œì§€
      const dc = fs.detected_columns || {};
      const parts = [];
      if (dc.date) parts.push(`ë‚ ì§œ: ${dc.date}`);
      if (dc.description) parts.push(`ì ìš”: ${dc.description}`);
      if (dc.income) parts.push(`ì…ê¸ˆ: ${dc.income}`);
      if (dc.expense) parts.push(`ì¶œê¸ˆ: ${dc.expense}`);
      if (dc.balance) parts.push(`ì”ì•¡: ${dc.balance}`);
      if (parts.length > 0) {
        document.getElementById('detect-msg').innerHTML = `<div class="detect-alert"><strong>ğŸ’¡ ìë™ ê°ì§€ëœ ì—´:</strong> ${parts.join(' | ')}</div>`;
      }

      // ì¹´í…Œê³ ë¦¬ ë¶„ì„
      const bd = fs.category_breakdown;
      if (bd && Object.keys(bd).length > 0) {
        document.getElementById('category-section').style.display = 'grid';
        renderCategoryAnalysis(bd);
        populateCategoryFilter(bd);
      }
    } else {
      document.getElementById('detect-msg').innerHTML = '<div class="detect-alert no-financial"><strong>â„¹ï¸</strong> ì…ê¸ˆ/ì¶œê¸ˆ ì—´ì„ ìë™ ê°ì§€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¬ë¬´ ìš”ì•½ ì—†ì´ ì „ì²´ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</div>';
    }

    // í…Œì´ë¸” í—¤ë”
    const thead = document.getElementById('data-thead');
    thead.innerHTML = `<tr>${allHeaders.map((h, i) => {
      const isSorted = String(i) === String(sortCol);
      const icon = isSorted ? (sortDir === 'asc' ? 'â–²' : 'â–¼') : 'â‡…';
      return `<th onclick="toggleSort(${i})">${escapeHtml(String(h || ''))}<span class="sort-icon">${icon}</span></th>`;
    }).join('')}<th>ê³„ì •ê³¼ëª©</th></tr>`;

    // í…Œì´ë¸” ë³¸ë¬¸
    const tbody = document.getElementById('data-tbody');
    const rows = d.rows || [];
    if (rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="' + (allHeaders.length + 1) + '" class="empty-state">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    } else {
      // ì…ê¸ˆ/ì¶œê¸ˆ ì—´ ì¸ë±ìŠ¤ (ìˆ«ì ì •ë ¬ìš©)
      const incomeIdx = financialCols.income ? allHeaders.indexOf(financialCols.income) : -1;
      const expenseIdx = financialCols.expense ? allHeaders.indexOf(financialCols.expense) : -1;
      const balanceIdx = financialCols.balance ? allHeaders.indexOf(financialCols.balance) : -1;
      const numericCols = new Set([incomeIdx, expenseIdx, balanceIdx].filter(i => i >= 0));

      tbody.innerHTML = rows.map((r, ri) => {
        const cells = r.cells || [];
        const cat = r.category || 'ë¯¸ë¶„ë¥˜';
        const catClass = cat === 'ë¯¸ë¶„ë¥˜' ? 'cell-category unclassified' : 'cell-category';
        const globalIdx = (currentPage - 1) * pageSize + ri;
        const isUserClassified = userClassifications[String(globalIdx)] ? ' user-classified' : '';
        const displayCat = userClassifications[String(globalIdx)] || cat;
        const displayCatClass = displayCat === 'ë¯¸ë¶„ë¥˜' ? 'cell-category unclassified' : 'cell-category';
        return `<tr>${cells.map((c, ci) => {
          const isNum = numericCols.has(ci);
          const cls = isNum ? ' class="cell-number"' : '';
          let val = c;
          if (isNum && c != null && c !== '') {
            try {
              const n = parseFloat(String(c).replace(/,/g, '').replace('ì›', ''));
              if (!isNaN(n)) val = n.toLocaleString();
            } catch(e) {}
          }
          return `<td${cls}>${escapeHtml(String(val ?? ''))}</td>`;
        }).join('')}<td><span class="${displayCatClass}${isUserClassified}" onclick="editCategory(${globalIdx}, this)" title="í´ë¦­í•˜ì—¬ ë¶„ë¥˜ ìˆ˜ì •">${escapeHtml(displayCat)}</span></td></tr>`;
      }).join('');
    }

    // í˜ì´ì§€ ì •ë³´
    document.getElementById('data-info').textContent = `${d.total.toLocaleString()}ê±´ ì¤‘ ${((d.page-1)*d.page_size+1).toLocaleString()}-${Math.min(d.page*d.page_size, d.total).toLocaleString()}ê±´`;

    // í˜ì´ì§€ë„¤ì´ì…˜
    renderPagination(d.page, d.total_pages);

  } catch(err) {
    console.error('Data load error:', err);
    showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (err.message || ''), 'error');
  }
}

function renderPagination(current, total) {
  const pag = document.getElementById('pagination');
  if (total <= 1) { pag.innerHTML = ''; return; }

  let btns = '';
  btns += `<button ${current <= 1 ? 'disabled' : ''} onclick="goPage(${current-1})">â€¹</button>`;
  
  // ìµœëŒ€ 7ê°œ ë²„íŠ¼
  let start = Math.max(1, current - 3);
  let end = Math.min(total, start + 6);
  start = Math.max(1, end - 6);
  
  if (start > 1) btns += `<button onclick="goPage(1)">1</button><button disabled>â€¦</button>`;
  for (let i = start; i <= end; i++) {
    btns += `<button class="${i === current ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
  }
  if (end < total) btns += `<button disabled>â€¦</button><button onclick="goPage(${total})">${total}</button>`;
  
  btns += `<button ${current >= total ? 'disabled' : ''} onclick="goPage(${current+1})">â€º</button>`;
  pag.innerHTML = btns;
}

function goPage(p) { currentPage = p; loadData(); }

function toggleSort(colIdx) {
  if (String(sortCol) === String(colIdx)) {
    sortDir = sortDir === 'asc' ? 'desc' : 'asc';
  } else {
    sortCol = colIdx;
    sortDir = 'asc';
  }
  currentPage = 1;
  loadData();
}

function renderCategoryAnalysis(breakdown) {
  const sorted = Object.entries(breakdown).sort((a, b) => (b[1].expense + b[1].income) - (a[1].expense + a[1].income));
  const maxVal = Math.max(...sorted.map(([, v]) => Math.max(v.income, v.expense)), 1);

  // í…Œì´ë¸”
  let html = '<table class="table table-sm" style="font-size:.85rem;"><thead><tr><th>ê³„ì •ê³¼ëª©</th><th style="text-align:right">ê±´ìˆ˜</th><th style="text-align:right">ì…ê¸ˆ</th><th style="text-align:right">ì¶œê¸ˆ</th></tr></thead><tbody>';
  for (const [cat, info] of sorted) {
    html += `<tr><td><span class="${cat === 'ë¯¸ë¶„ë¥˜' ? 'cell-category unclassified' : 'cell-category'}">${escapeHtml(cat)}</span></td>`;
    html += `<td style="text-align:right">${info.count}</td>`;
    html += `<td style="text-align:right;color:#10b981;">${info.income ? Math.round(info.income).toLocaleString() : '-'}</td>`;
    html += `<td style="text-align:right;color:#ef4444;">${info.expense ? Math.round(info.expense).toLocaleString() : '-'}</td></tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('category-table-body').innerHTML = html;

  // ë°” ì°¨íŠ¸
  let chart = '';
  for (const [cat, info] of sorted) {
    const incW = Math.max((info.income / maxVal) * 100, 0);
    const expW = Math.max((info.expense / maxVal) * 100, 0);
    chart += `<div class="bar-wrap"><span class="bar-label">${escapeHtml(cat)}</span>`;
    if (info.income > 0) chart += `<div class="bar bar-income" style="width:${incW}%" title="ì…ê¸ˆ: ${Math.round(info.income).toLocaleString()}"></div>`;
    if (info.expense > 0) chart += `<div class="bar bar-expense" style="width:${expW}%" title="ì¶œê¸ˆ: ${Math.round(info.expense).toLocaleString()}"></div>`;
    chart += '</div>';
  }
  document.getElementById('category-chart').innerHTML = chart || '<p class="text-muted">ë°ì´í„° ì—†ìŒ</p>';
}

function populateCategoryFilter(breakdown) {
  const sel = document.getElementById('category-filter');
  for (const cat of Object.keys(breakdown).sort()) {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    sel.appendChild(opt);
  }
}

// ë‹¤ìš´ë¡œë“œ
document.getElementById('btn-download').addEventListener('click', async () => {
  try {
    const token = API.getToken();
    if (!token) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
    let resp = await fetch(`/api/documents/documents/${DOC_ID}/download_data/`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (resp.status === 401) {
      await API.refreshToken();
      resp = await fetch(`/api/documents/documents/${DOC_ID}/download_data/`, {
        headers: { 'Authorization': `Bearer ${API.getToken()}` }
      });
    }
    if (!resp.ok) throw new Error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
    const blob = await resp.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ê¸°ì¥ì •ë¦¬_${DOC_ID}.xlsx`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
    showToast('ê¸°ì¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
  } catch(err) {
    showToast(err.message || 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'error');
  }
});

// ê²€ìƒ‰
let searchTimer;
document.getElementById('search-input').addEventListener('input', (e) => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => {
    searchQuery = e.target.value.trim();
    currentPage = 1;
    loadData();
  }, 400);
});

// ì¹´í…Œê³ ë¦¬ í•„í„°
document.getElementById('category-filter').addEventListener('change', (e) => {
  categoryFilter = e.target.value;
  currentPage = 1;
  loadData();
});

// í˜ì´ì§€ ì‚¬ì´ì¦ˆ
document.getElementById('page-size-select').addEventListener('change', (e) => {
  pageSize = parseInt(e.target.value);
  currentPage = 1;
  loadData();
});

// ë¬¸ì„œ ê¸°ë³¸ ì •ë³´ ë¡œë“œ
async function loadDocInfo() {
  try {
    const doc = await API.get(`/api/documents/documents/${DOC_ID}/`);
    document.getElementById('doc-info').innerHTML = `
      <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:.5rem;">
        <h3 style="margin:0;font-size:1.1rem;">${escapeHtml(doc.original_filename)}</h3>
        ${statusBadge(doc.status)}
        <span class="badge badge-type">${doc.file_type}</span>
        <span class="text-muted" style="font-size:.85rem;">${formatSize(doc.file_size)} Â· ${formatDate(doc.created_at)}</span>
      </div>
    `;
  } catch(err) {}
}

document.addEventListener('DOMContentLoaded', () => {
  loadDocInfo();
  loadData();
});

// ========================
// ê³„ì •ê³¼ëª© ì¸ë¼ì¸ ìˆ˜ì •
// ========================

const CATEGORIES = [
  'ë§¤ì¶œ', 'ì´ììˆ˜ìµ', 'ì¡ìˆ˜ì…', 'ê¸‰ì—¬', 'ë³µë¦¬í›„ìƒë¹„', 'ì†Œëª¨í’ˆë¹„', 'ì ‘ëŒ€ë¹„',
  'ì—¬ë¹„êµí†µë¹„', 'í†µì‹ ë¹„', 'ìˆ˜ë„ê´‘ì—´ë¹„', 'ì„ì°¨ë£Œ', 'ë³´í—˜ë£Œ', 'ì„¸ê¸ˆê³¼ê³µê³¼',
  'ê´‘ê³ ì„ ì „ë¹„', 'ìˆ˜ìˆ˜ë£Œ', 'ì´ìë¹„ìš©', 'ê°ê°€ìƒê°ë¹„', 'ì™¸ì£¼ë¹„', 'ìˆ˜ì„ ë¹„', 'ë¯¸ë¶„ë¥˜'
];

function editCategory(rowIndex, spanEl) {
  // ì´ë¯¸ ì…€ë ‰íŠ¸ê°€ ì—´ë ¤ìˆìœ¼ë©´ ë¬´ì‹œ
  if (spanEl.querySelector('select')) return;
  
  const currentCat = userClassifications[String(rowIndex)] || spanEl.textContent.trim();
  const td = spanEl.parentElement;
  
  const select = document.createElement('select');
  select.className = 'cat-select';
  
  CATEGORIES.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    if (cat === currentCat) opt.selected = true;
    select.appendChild(opt);
  });
  
  spanEl.style.display = 'none';
  td.appendChild(select);
  select.focus();
  
  async function saveAndClose() {
    const newCat = select.value;
    select.remove();
    spanEl.style.display = '';
    
    if (newCat !== currentCat) {
      userClassifications[String(rowIndex)] = newCat;
      spanEl.textContent = newCat;
      spanEl.className = newCat === 'ë¯¸ë¶„ë¥˜' 
        ? 'cell-category unclassified user-classified' 
        : 'cell-category user-classified';
      
      // ì„œë²„ì— ì €ì¥
      try {
        await API.post(`/api/documents/documents/${DOC_ID}/classify/`, {
          classifications: { [String(rowIndex)]: newCat }
        });
        showToast(`í–‰ ${rowIndex + 1}: ${newCat}ìœ¼ë¡œ ë¶„ë¥˜ ì €ì¥`);
      } catch(err) {
        showToast('ë¶„ë¥˜ ì €ì¥ ì‹¤íŒ¨: ' + (err.message || ''), 'error');
      }
    }
  }
  
  select.addEventListener('change', saveAndClose);
  select.addEventListener('blur', saveAndClose);
}

// ========================
// ê±°ë˜ì²˜ ìë™ ì¶”ì¶œ
// ========================

document.getElementById('btn-extract-vendors').addEventListener('click', async () => {
  if (!confirm('ê±°ë˜ ë‚´ì—­ì—ì„œ ê±°ë˜ì²˜ë¥¼ ìë™ ì¶”ì¶œí•©ë‹ˆë‹¤. ê¸°ì¡´ ê±°ë˜ì²˜ ì •ë³´ëŠ” ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.')) return;
  
  try {
    const result = await API.post(`/api/documents/documents/${DOC_ID}/extract_vendors/`);
    showToast(`${result.message} (ì´ ${result.total_vendors}ê°œ)`);
  } catch(err) {
    showToast('ê±°ë˜ì²˜ ì¶”ì¶œ ì‹¤íŒ¨: ' + (err.message || ''), 'error');
  }
});
</script>
{% endblock %}
