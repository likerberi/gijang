{% extends "base.html" %}
{% block title %}ë§¤í•‘ í…œí”Œë¦¿ - DocMerge{% endblock %}
{% block nav_templates %}active{% endblock %}
{% block page_title %}ë§¤í•‘ í…œí”Œë¦¿{% endblock %}

{% block content %}
<div class="section-header mb-2">
  <p class="text-muted">ìì£¼ ì‚¬ìš©í•˜ëŠ” ì—´ ë§¤í•‘ ê·œì¹™ì„ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥í•´ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  <button class="btn btn-primary" id="btn-new-template">+ ìƒˆ í…œí”Œë¦¿</button>
</div>

<div class="table-wrap">
  <table class="table">
    <thead>
      <tr>
        <th>ì´ë¦„</th>
        <th>ì„¤ëª…</th>
        <th>ë§¤í•‘ ìˆ˜</th>
        <th>ìƒì„±ì¼</th>
        <th>ì‘ì—…</th>
      </tr>
    </thead>
    <tbody id="templates-body">
      <tr><td colspan="5" class="empty-state">ë¡œë”© ì¤‘...</td></tr>
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function loadTemplates() {
  try {
    const data = await API.get('/api/documents/mapping-templates/');
    const results = data.results || [];
    const tbody = document.getElementById('templates-body');

    if (results.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="empty-state">ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    } else {
      tbody.innerHTML = results.map(t => {
        const mappingCount = t.column_mapping ? Object.keys(t.column_mapping).length : 0;
        return `
          <tr>
            <td><strong>${escapeHtml(t.name)}</strong></td>
            <td class="text-muted">${escapeHtml(t.description || '-')}</td>
            <td>${mappingCount}ê°œ</td>
            <td>${formatDate(t.created_at)}</td>
            <td class="actions">
              <button class="btn btn-xs btn-ghost" onclick="viewTemplate(${t.id})">ë³´ê¸°</button>
              <button class="btn btn-xs btn-danger" onclick="deleteTemplate(${t.id})">ğŸ—‘</button>
            </td>
          </tr>
        `;
      }).join('');
    }
  } catch(err) {
    showToast('í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
  }
}

async function viewTemplate(id) {
  try {
    const t = await API.get(`/api/documents/mapping-templates/${id}/`);
    const mapping = t.column_mapping || {};
    const dateCols = t.date_columns || [];
    const numberCols = t.number_columns || [];

    let mappingRows = Object.entries(mapping).map(([from, to]) =>
      `<tr><td><code>${escapeHtml(from)}</code></td><td>â†’</td><td><strong>${escapeHtml(to)}</strong></td></tr>`
    ).join('');

    showModal(escapeHtml(t.name), `
      ${t.description ? `<p class="text-muted">${escapeHtml(t.description)}</p>` : ''}
      <div class="section">
        <h5>ì—´ ë§¤í•‘</h5>
        ${mappingRows ? `
          <table class="table table-sm"><tbody>${mappingRows}</tbody></table>
        ` : '<p class="text-muted">ë§¤í•‘ ì—†ìŒ</p>'}
      </div>
      ${dateCols.length ? `<div class="section"><h5>ë‚ ì§œ ì—´</h5><p>${dateCols.map(c => `<span class="badge badge-info">${escapeHtml(c)}</span>`).join(' ')}</p></div>` : ''}
      ${numberCols.length ? `<div class="section"><h5>ìˆ«ì ì—´</h5><p>${numberCols.map(c => `<span class="badge badge-warning">${escapeHtml(c)}</span>`).join(' ')}</p></div>` : ''}
    `);
  } catch(err) {
    showToast('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
  }
}

async function deleteTemplate(id) {
  if (!confirm('ì´ í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await API.delete(`/api/documents/mapping-templates/${id}/`);
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    loadTemplates();
  } catch(err) {
    showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
  }
}

document.getElementById('btn-new-template').addEventListener('click', () => {
  showModal('ìƒˆ ë§¤í•‘ í…œí”Œë¦¿', `
    <form id="new-template-form">
      <div class="form-group">
        <label>ì´ë¦„ <span class="required">*</span></label>
        <input type="text" id="tpl-name" class="form-input" required>
      </div>
      <div class="form-group">
        <label>ì„¤ëª…</label>
        <textarea id="tpl-desc" class="form-textarea" rows="2"></textarea>
      </div>
      <div class="form-group">
        <label>ì—´ ë§¤í•‘ (JSON)</label>
        <textarea id="tpl-mapping" class="form-textarea" rows="4" placeholder='{"ë§¤ì¶œì•¡": "sales", "ê±°ë˜ì²˜": "customer"}'>{}</textarea>
      </div>
      <div class="form-group">
        <label>ë‚ ì§œ ì—´ (ì½¤ë§ˆ êµ¬ë¶„)</label>
        <input type="text" id="tpl-date-cols" class="form-input" placeholder="ë‚ ì§œ, date">
      </div>
      <div class="form-group">
        <label>ìˆ«ì ì—´ (ì½¤ë§ˆ êµ¬ë¶„)</label>
        <input type="text" id="tpl-number-cols" class="form-input" placeholder="ê¸ˆì•¡, amount">
      </div>
      <button type="submit" class="btn btn-primary btn-full">ìƒì„±</button>
    </form>
  `);

  document.getElementById('new-template-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      const mapping = JSON.parse(document.getElementById('tpl-mapping').value || '{}');
      const dateCols = document.getElementById('tpl-date-cols').value.split(',').map(s => s.trim()).filter(Boolean);
      const numberCols = document.getElementById('tpl-number-cols').value.split(',').map(s => s.trim()).filter(Boolean);

      await API.post('/api/documents/mapping-templates/', {
        name: document.getElementById('tpl-name').value,
        description: document.getElementById('tpl-desc').value,
        column_mapping: mapping,
        date_columns: dateCols,
        number_columns: numberCols,
      });
      closeModal();
      showToast('í…œí”Œë¦¿ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
      loadTemplates();
    } catch(err) {
      showToast(err.message || 'ìƒì„± ì‹¤íŒ¨', 'error');
    }
  });
});

document.addEventListener('DOMContentLoaded', loadTemplates);
</script>
{% endblock %}
