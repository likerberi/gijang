{% extends "base.html" %}
{% block title %}ëŒ€ì‹œë³´ë“œ - ê¸°ì¥{% endblock %}
{% block nav_dashboard %}active{% endblock %}
{% block page_title %}ê¸°ì¥ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block extra_head %}
<style>
.fin-overview { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.fin-ov-card { background: #fff; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,.06); border-left: 4px solid var(--c-gray-200); }
.fin-ov-card.income { border-left-color: #10b981; }
.fin-ov-card.expense { border-left-color: #ef4444; }
.fin-ov-card.net { border-left-color: #2563eb; }
.fin-ov-card.files { border-left-color: #8b5cf6; }
.fin-ov-card .ov-label { font-size: .8rem; color: var(--c-gray-500); margin-bottom: .25rem; }
.fin-ov-card .ov-value { font-size: 1.4rem; font-weight: 700; }
.fin-ov-card.income .ov-value { color: #10b981; }
.fin-ov-card.expense .ov-value { color: #ef4444; }
.fin-ov-card.net .ov-value { color: #2563eb; }
@media (max-width: 768px) { .fin-overview { grid-template-columns: 1fr 1fr; } }
</style>
{% endblock %}

{% block content %}
<!-- ì¬ë¬´ ìš”ì•½ -->
<div class="fin-overview" id="fin-overview">
  <div class="fin-ov-card income">
    <div class="ov-label">ì´ ì…ê¸ˆ í•©ê³„</div>
    <div class="ov-value" id="ov-income">-</div>
  </div>
  <div class="fin-ov-card expense">
    <div class="ov-label">ì´ ì¶œê¸ˆ í•©ê³„</div>
    <div class="ov-value" id="ov-expense">-</div>
  </div>
  <div class="fin-ov-card net">
    <div class="ov-label">ìˆœì´ìµ í•©ê³„</div>
    <div class="ov-value" id="ov-net">-</div>
  </div>
  <div class="fin-ov-card files">
    <div class="ov-label">ì²˜ë¦¬ëœ ë¬¸ì„œ</div>
    <div class="ov-value" id="ov-files">-</div>
  </div>
</div>

<!-- ë¹ ë¥¸ ì‘ì—… -->
<div class="section">
  <h3 class="section-title">ë¹ ë¥¸ ì‹œì‘</h3>
  <div class="quick-actions">
    <a href="/app/documents/" class="action-card">
      <div class="action-icon">ğŸ“¤</div>
      <div class="action-title">ê±°ë˜ë‚´ì—­ ì—…ë¡œë“œ</div>
      <div class="action-desc">ì€í–‰/ì¹´ë“œ ê±°ë˜ ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ ë¶„ì„í•©ë‹ˆë‹¤</div>
    </a>
    <a href="/app/vendors/" class="action-card">
      <div class="action-icon">ğŸ¢</div>
      <div class="action-title">ê±°ë˜ì²˜ ê´€ë¦¬</div>
      <div class="action-desc">ë§¤ì¶œì²˜/ë§¤ì…ì²˜ë¥¼ ê´€ë¦¬í•˜ê³  ê±°ë˜ í†µê³„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤</div>
    </a>
    <a href="/app/tax-calendar/" class="action-card">
      <div class="action-icon">ğŸ“…</div>
      <div class="action-title">ì„¸ê¸ˆ ë‹¬ë ¥</div>
      <div class="action-desc">ë¶€ê°€ì„¸Â·ì›ì²œì„¸Â·ì¢…í•©ì†Œë“ì„¸ ì¼ì •ì„ í•œëˆˆì— í™•ì¸í•©ë‹ˆë‹¤</div>
    </a>
    <a href="/app/merge/" class="action-card">
      <div class="action-icon">ğŸ”—</div>
      <div class="action-title">íŒŒì¼ ë³‘í•©</div>
      <div class="action-desc">ì—¬ëŸ¬ ê±°ë˜ë‚´ì—­ íŒŒì¼ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ê³  ê³„ì •ê³¼ëª©ì„ ì •ë¦¬í•©ë‹ˆë‹¤</div>
    </a>
    <a href="/app/templates/" class="action-card">
      <div class="action-icon">ğŸ“‹</div>
      <div class="action-title">ë§¤í•‘ í…œí”Œë¦¿</div>
      <div class="action-desc">ì€í–‰/ì¹´ë“œì‚¬ë³„ ì—´ ì´ë¦„ ë§¤í•‘ì„ ì €ì¥í•˜ê³  ì¬ì‚¬ìš©í•©ë‹ˆë‹¤</div>
    </a>
  </div>
</div>

<!-- ë‹¤ìŒ ì„¸ê¸ˆ ì¼ì • -->
<div class="section" id="tax-next-section" style="display:none;">
  <div style="background:linear-gradient(135deg,#2563eb,#7c3aed);color:#fff;border-radius:12px;padding:1.25rem;display:flex;align-items:center;gap:1.5rem;">
    <div style="font-size:2rem;">â°</div>
    <div style="flex:1;">
      <div style="font-weight:700;font-size:1.1rem;" id="tax-next-title">-</div>
      <div style="font-size:.85rem;opacity:.85;" id="tax-next-desc">-</div>
    </div>
    <div style="text-align:right;">
      <div style="font-size:1.8rem;font-weight:800;" id="tax-next-days">-</div>
      <div style="font-size:.75rem;">ì¼ ë‚¨ìŒ</div>
    </div>
    <a href="/app/tax-calendar/" class="btn btn-sm" style="background:rgba(255,255,255,.2);color:#fff;border:none;">ë‹¬ë ¥ ë³´ê¸° â†’</a>
  </div>
</div>

<!-- ìµœê·¼ ë¬¸ì„œ -->
<div class="section">
  <div class="section-header">
    <h3 class="section-title">ìµœê·¼ ì²˜ë¦¬ ë¬¸ì„œ</h3>
    <a href="/app/documents/" class="btn btn-sm btn-ghost">ì „ì²´ ë³´ê¸° â†’</a>
  </div>
  <div class="table-wrap">
    <table class="table" id="recent-docs-table">
      <thead>
        <tr>
          <th>íŒŒì¼ëª…</th>
          <th>ìœ í˜•</th>
          <th>ìƒíƒœ</th>
          <th>í–‰ ìˆ˜</th>
          <th>í¬ê¸°</th>
          <th>ì—…ë¡œë“œì¼</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="recent-docs-body">
        <tr><td colspan="7" class="empty-state">ë¡œë”© ì¤‘...</td></tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function money(v) {
  if (v == null || isNaN(v)) return '-';
  return Math.round(v).toLocaleString() + 'ì›';
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    // ë¬¸ì„œ ëª©ë¡ ë¡œë“œ
    const docs = await API.get('/api/documents/documents/?page_size=10');
    const results = docs.results || [];

    // ìµœê·¼ ë¬¸ì„œ í…Œì´ë¸”
    const tbody = document.getElementById('recent-docs-body');
    if (results.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ê±°ë˜ë‚´ì—­ ì—‘ì…€ì„ ì—…ë¡œë“œí•´ë³´ì„¸ìš”!</td></tr>';
    } else {
      tbody.innerHTML = results.map(d => `
        <tr>
          <td><strong>${escapeHtml(d.original_filename)}</strong></td>
          <td><span class="badge badge-type">${d.file_type}</span></td>
          <td>${statusBadge(d.status)}</td>
          <td>${d.status === 'completed' ? '-' : '-'}</td>
          <td>${formatSize(d.file_size)}</td>
          <td>${formatDate(d.created_at)}</td>
          <td>${d.status === 'completed' ? `<a href="/app/documents/${d.id}/" class="btn btn-xs btn-primary">ğŸ“Š ë³´ê¸°</a>` : ''}</td>
        </tr>
      `).join('');
    }

    // íŒŒì¼ í†µê³„
    const completedDocs = results.filter(d => d.status === 'completed');
    document.getElementById('ov-files').textContent = `${completedDocs.length} / ${docs.count || results.length}`;

    // ì¬ë¬´ ìš”ì•½ ì§‘ê³„ (ì™„ë£Œëœ ë¬¸ì„œë“¤ì˜ ìš”ì•½ í•©ê³„)
    let totalIncome = 0, totalExpense = 0;
    let hasFinancial = false;
    
    for (const doc of completedDocs.slice(0, 5)) {
      try {
        const sum = await API.get(`/api/documents/documents/${doc.id}/summary/`);
        if (sum.financial_summary) {
          hasFinancial = true;
          totalIncome += sum.financial_summary.total_income || 0;
          totalExpense += sum.financial_summary.total_expense || 0;
        }
      } catch(e) {}
    }

    if (hasFinancial) {
      document.getElementById('ov-income').textContent = money(totalIncome);
      document.getElementById('ov-expense').textContent = money(totalExpense);
      document.getElementById('ov-net').textContent = money(totalIncome - totalExpense);
    } else {
      document.getElementById('ov-income').textContent = '-';
      document.getElementById('ov-expense').textContent = '-';
      document.getElementById('ov-net').textContent = '-';
    }

  } catch (err) {
    console.error('Dashboard load error:', err);
  }

  // ë‹¤ìŒ ì„¸ê¸ˆ ì¼ì •
  try {
    const cal = await API.get('/api/documents/tax-calendar/');
    if (cal.next_event) {
      const ne = cal.next_event;
      document.getElementById('tax-next-section').style.display = 'block';
      document.getElementById('tax-next-title').textContent = `${ne.date} - ${ne.title}`;
      document.getElementById('tax-next-desc').textContent = ne.description;
      document.getElementById('tax-next-days').textContent = ne.days_until;
    }
  } catch(e) {}
});
</script>
{% endblock %}
