{% extends "base.html" %}
{% block title %}ì›”ë³„ ì†ìµ ë¦¬í¬íŠ¸ - ê¸°ì¥{% endblock %}
{% block nav_documents %}active{% endblock %}
{% block page_title %}ì›”ë³„ ì†ìµ ë¦¬í¬íŠ¸{% endblock %}

{% block top_actions %}
<button class="btn btn-ghost" onclick="location.href='/app/documents/{{ doc_id }}/'">â† ê±°ë˜ë‚´ì—­</button>
{% endblock %}

{% block extra_head %}
<style>
.report-total { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
.rt-card { background: #fff; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,.06); }
.rt-card .rt-label { font-size: .8rem; color: var(--c-gray-500); margin-bottom: .25rem; }
.rt-card .rt-value { font-size: 1.5rem; font-weight: 700; }
.rt-card.income { border-left: 4px solid #10b981; }
.rt-card.income .rt-value { color: #10b981; }
.rt-card.expense { border-left: 4px solid #ef4444; }
.rt-card.expense .rt-value { color: #ef4444; }
.rt-card.net { border-left: 4px solid #2563eb; }
.rt-card.net .rt-value { color: #2563eb; }
.rt-card.count { border-left: 4px solid #8b5cf6; }

/* ì›”ë³„ ì°¨íŠ¸ */
.chart-section { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 4px rgba(0,0,0,.06); margin-bottom: 1.5rem; }
.chart-section h4 { margin: 0 0 1rem; font-size: 1rem; }
.month-chart { display: flex; gap: 2px; align-items: flex-end; height: 250px; padding: 0; }
.month-bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; height: 100%; justify-content: flex-end; }
.month-bars { display: flex; gap: 2px; align-items: flex-end; width: 100%; justify-content: center; }
.month-bar { width: 16px; border-radius: 3px 3px 0 0; min-height: 2px; transition: height .4s ease; }
.month-bar.inc { background: #10b981; }
.month-bar.exp { background: #ef4444; }
.month-label { font-size: .7rem; color: var(--c-gray-500); margin-top: 4px; white-space: nowrap; }

/* ì›”ë³„ í…Œì´ë¸” */
.month-table-wrap { background: #fff; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,.06); margin-bottom: 1.5rem; }
.month-table { width: 100%; border-collapse: collapse; font-size: .85rem; }
.month-table th { background: #f8fafc; padding: .6rem .5rem; text-align: left; border-bottom: 2px solid var(--c-gray-200); }
.month-table td { padding: .5rem; border-bottom: 1px solid var(--c-gray-100); }
.month-table td.num { text-align: right; font-variant-numeric: tabular-nums; }
.month-table tr.total-row { background: #f1f5f9; font-weight: 600; }
.inc-val { color: #10b981; }
.exp-val { color: #ef4444; }
.net-val { color: #2563eb; }

/* ì¹´í…Œê³ ë¦¬ ìƒì„¸ í† ê¸€ */
.cat-detail { display: none; }
.cat-detail.open { display: table-row; }
.cat-detail td { padding-left: 2rem; font-size: .8rem; background: #fafbfc; }
.toggle-btn { cursor: pointer; color: var(--c-primary); text-decoration: underline; font-size: .8rem; }

/* ëˆ„ì  ì°¨íŠ¸ */
.cumul-chart { position: relative; height: 200px; margin-top: 1rem; }
.cumul-line { position: absolute; bottom: 0; width: 3px; border-radius: 2px; }
.cumul-line.income-line { background: rgba(16,185,129,.3); }
.cumul-line.expense-line { background: rgba(239,68,68,.3); }
.cumul-line.net-line { background: rgba(37,99,235,.5); }

.legend { display: flex; gap: 1.5rem; margin-top: .5rem; }
.legend-item { display: flex; align-items: center; gap: .35rem; font-size: .8rem; color: var(--c-gray-500); }
.legend-dot { width: 10px; height: 10px; border-radius: 2px; }

@media (max-width: 768px) {
  .report-total { grid-template-columns: 1fr 1fr; }
  .month-bar { width: 10px; }
}
</style>
{% endblock %}

{% block content %}
<div id="loading" class="empty-state">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<!-- í•©ê³„ ì¹´ë“œ -->
<div class="report-total" id="report-total" style="display:none;">
  <div class="rt-card income">
    <div class="rt-label">ì´ ìˆ˜ì…</div>
    <div class="rt-value" id="rt-income">-</div>
  </div>
  <div class="rt-card expense">
    <div class="rt-label">ì´ ì§€ì¶œ</div>
    <div class="rt-value" id="rt-expense">-</div>
  </div>
  <div class="rt-card net">
    <div class="rt-label">ìˆœì´ìµ</div>
    <div class="rt-value" id="rt-net">-</div>
  </div>
  <div class="rt-card count">
    <div class="rt-label">ì´ ê±°ë˜</div>
    <div class="rt-value" id="rt-count">-</div>
  </div>
</div>

<!-- ì›”ë³„ ë§‰ëŒ€ ì°¨íŠ¸ -->
<div class="chart-section" id="chart-section" style="display:none;">
  <h4>ğŸ“Š ì›”ë³„ ìˆ˜ì…/ì§€ì¶œ ì¶”ì´</h4>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#10b981;"></div> ìˆ˜ì…</div>
    <div class="legend-item"><div class="legend-dot" style="background:#ef4444;"></div> ì§€ì¶œ</div>
  </div>
  <div class="month-chart" id="month-chart"></div>
</div>

<!-- ì›”ë³„ í…Œì´ë¸” -->
<div class="month-table-wrap" id="table-section" style="display:none;">
  <h4 style="margin:0 0 1rem;font-size:1rem;">ğŸ“‹ ì›”ë³„ ìƒì„¸</h4>
  <table class="month-table" id="month-table">
    <thead>
      <tr>
        <th>ì›”</th>
        <th style="text-align:right">ìˆ˜ì…</th>
        <th style="text-align:right">ì§€ì¶œ</th>
        <th style="text-align:right">ìˆœì´ìµ</th>
        <th style="text-align:right">ê±°ë˜ê±´ìˆ˜</th>
        <th style="text-align:right">ëˆ„ì  ìˆœì´ìµ</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="month-tbody"></tbody>
  </table>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const DOC_ID = {{ doc_id }};

function money(v) {
  if (v == null || isNaN(v)) return '-';
  return Math.round(v).toLocaleString() + 'ì›';
}

async function loadReport() {
  try {
    const d = await API.get(`/api/documents/documents/${DOC_ID}/monthly_report/`);
    document.getElementById('loading').style.display = 'none';
    
    const months = d.months || [];
    const total = d.total || {};
    
    if (months.length === 0) {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('loading').textContent = 'ì›”ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‚ ì§œ ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.';
      return;
    }
    
    // í•©ê³„ ì¹´ë“œ
    document.getElementById('report-total').style.display = 'grid';
    document.getElementById('rt-income').textContent = money(total.income);
    document.getElementById('rt-expense').textContent = money(total.expense);
    document.getElementById('rt-net').textContent = money(total.net);
    document.getElementById('rt-count').textContent = (total.transaction_count || 0).toLocaleString() + 'ê±´';
    
    // ë§‰ëŒ€ ì°¨íŠ¸
    document.getElementById('chart-section').style.display = 'block';
    const chartDiv = document.getElementById('month-chart');
    const maxVal = Math.max(...months.map(m => Math.max(m.income || 0, m.expense || 0)), 1);
    
    chartDiv.innerHTML = months.map(m => {
      const incH = Math.max((m.income / maxVal) * 220, 2);
      const expH = Math.max((m.expense / maxVal) * 220, 2);
      return `<div class="month-bar-group">
        <div class="month-bars">
          <div class="month-bar inc" style="height:${incH}px" title="ìˆ˜ì…: ${money(m.income)}"></div>
          <div class="month-bar exp" style="height:${expH}px" title="ì§€ì¶œ: ${money(m.expense)}"></div>
        </div>
        <div class="month-label">${m.month.substring(5)}</div>
      </div>`;
    }).join('');
    
    // í…Œì´ë¸”
    document.getElementById('table-section').style.display = 'block';
    const tbody = document.getElementById('month-tbody');
    let html = '';
    
    months.forEach((m, idx) => {
      const netClass = m.net >= 0 ? 'net-val' : 'exp-val';
      const cumulClass = m.cumulative_net >= 0 ? 'net-val' : 'exp-val';
      const cats = m.categories || {};
      const hasCats = Object.keys(cats).length > 0;
      
      html += `<tr>
        <td><strong>${m.month}</strong></td>
        <td class="num inc-val">${money(m.income)}</td>
        <td class="num exp-val">${money(m.expense)}</td>
        <td class="num ${netClass}">${money(m.net)}</td>
        <td class="num">${m.count}ê±´</td>
        <td class="num ${cumulClass}">${money(m.cumulative_net)}</td>
        <td>${hasCats ? `<span class="toggle-btn" onclick="toggleCats(${idx})">ìƒì„¸</span>` : ''}</td>
      </tr>`;
      
      // ì¹´í…Œê³ ë¦¬ ìƒì„¸ (ìˆ¨ê¹€)
      if (hasCats) {
        html += `<tr class="cat-detail" id="cat-detail-${idx}"><td colspan="7">
          <table style="width:100%;font-size:.8rem;"><thead><tr>
            <th>ê³„ì •ê³¼ëª©</th><th style="text-align:right">ê±´ìˆ˜</th>
            <th style="text-align:right">ìˆ˜ì…</th><th style="text-align:right">ì§€ì¶œ</th>
          </tr></thead><tbody>`;
        for (const [cat, info] of Object.entries(cats).sort((a,b) => (b[1].income + b[1].expense) - (a[1].income + a[1].expense))) {
          html += `<tr>
            <td><span class="cat-badge" style="font-size:.7rem;">${escapeHtml(cat)}</span></td>
            <td class="num">${info.count}</td>
            <td class="num inc-val">${info.income ? money(info.income) : '-'}</td>
            <td class="num exp-val">${info.expense ? money(info.expense) : '-'}</td>
          </tr>`;
        }
        html += '</tbody></table></td></tr>';
      }
    });
    
    // í•©ê³„ í–‰
    html += `<tr class="total-row">
      <td><strong>í•©ê³„</strong></td>
      <td class="num inc-val"><strong>${money(total.income)}</strong></td>
      <td class="num exp-val"><strong>${money(total.expense)}</strong></td>
      <td class="num ${total.net >= 0 ? 'net-val' : 'exp-val'}"><strong>${money(total.net)}</strong></td>
      <td class="num"><strong>${total.transaction_count}ê±´</strong></td>
      <td class="num"></td>
      <td></td>
    </tr>`;
    
    tbody.innerHTML = html;
    
  } catch(err) {
    document.getElementById('loading').innerHTML = `<span style="color:#ef4444;">ì˜¤ë¥˜: ${err.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨'}</span>`;
  }
}

function toggleCats(idx) {
  const row = document.getElementById(`cat-detail-${idx}`);
  if (row) row.classList.toggle('open');
}

document.addEventListener('DOMContentLoaded', loadReport);
</script>
{% endblock %}
